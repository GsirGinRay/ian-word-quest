<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ians Game Console</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
@import url("https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Nunito:wght@400;700&display=swap");
body{font-family:"Nunito",sans-serif;background-color:#111827;user-select:none}.pixel-font{font-family:"Press Start 2P",cursive}.view-section{display:none;opacity:0;transition:opacity .3s ease-in-out}.view-section.active{display:flex;opacity:1}@keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-10px)}100%{transform:translateY(0)}}.floating{animation:float 3s ease-in-out infinite}.card-hover:hover{transform:translateY(-4px);box-shadow:0 10px 25px -5px rgba(0,0,0,.3)}.shake{animation:shake .5s}@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
</style>
</head>
<body class="h-screen w-full text-white overflow-hidden bg-gray-900">
<div id="sys-status" class="fixed top-0 left-0 w-full bg-blue-600 text-white text-xs font-bold p-1 z-50 text-center shadow-lg">üîµ System Initializing...</div>

<div id="login-view" class="view-section active flex-col items-center justify-center h-full w-full relative">
<div class="z-10 text-center space-y-8">
<h1 class="text-4xl md:text-6xl text-yellow-400 pixel-font mb-8 drop-shadow-lg floating">IANS CONSOLE</h1>
<p class="text-gray-300 text-xl mb-8">Who is playing?</p>
<div id="user-list" class="flex flex-wrap gap-6 justify-center max-w-4xl px-4"><p class="text-gray-500">Loading players...</p></div>
<div class="mt-12"><button id="btn-add-user" class="text-gray-500 hover:text-white underline text-sm border p-2 rounded border-gray-600">+ Add New Player</button></div>
</div>
<div id="add-user-modal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center">
<div class="bg-gray-800 p-6 rounded-lg w-80 border border-gray-600">
<h3 class="text-xl font-bold mb-4">New Hero</h3>
<input type="text" id="new-username" placeholder="Name" class="w-full bg-gray-700 p-2 rounded mb-4 text-white">
<div class="flex gap-2 justify-end"><button id="btn-cancel-user" class="text-gray-400 px-4 py-2">Cancel</button><button id="btn-create-user" class="bg-blue-600 px-4 py-2 rounded text-white">Create</button></div>
</div>
</div>
</div>

<div id="dashboard-view" class="view-section flex-col h-full w-full">
<div class="w-full bg-gray-800 p-4 shadow-lg flex justify-between items-center z-20 border-b border-gray-700">
<div class="flex items-center gap-4"><button id="btn-logout" class="text-gray-400 hover:text-white">‚Üê Logout</button>
<div class="flex items-center gap-2 bg-gray-900 px-4 py-2 rounded-full border border-gray-600"><span id="dash-avatar" class="text-2xl">üë¶</span><div><div id="dash-name" class="font-bold text-sm leading-none">Ian</div><div class="text-xs text-yellow-400 pixel-font mt-1" id="dash-level">LV.1</div></div></div></div>
<button id="btn-admin" class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-xs">‚öôÔ∏è Parent Zone</button>
</div>
<div class="flex-1 overflow-y-auto p-4 md:p-8">
<h2 class="text-2xl font-bold mb-6 border-l-4 border-yellow-500 pl-4">Mission Select</h2>
<div id="level-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
<div id="empty-levels-msg" class="hidden text-center text-gray-500 mt-20"><p>No missions available yet.</p><p class="text-sm">Go to Parent Zone to add missions!</p></div>
</div>
</div>

<div id="game-view" class="view-section flex-col h-full w-full bg-gray-900">
<div class="w-full bg-gray-800 p-2 flex justify-between items-center border-b border-gray-700">
<button id="btn-quit" class="text-red-400 hover:text-red-300 font-bold px-3">EXIT üè≥Ô∏è</button>
<div class="flex-1 mx-4"><div class="h-3 bg-gray-700 rounded-full overflow-hidden border border-gray-600 relative"><div id="battle-progress" class="h-full bg-red-600 transition-all duration-300" style="width: 0%"></div></div></div>
<div class="pixel-font text-yellow-400 text-sm"><span id="monsters-killed">0</span>/5</div>
</div>
<div class="flex-1 flex flex-col items-center justify-center p-4 relative overflow-hidden">
<div class="mb-4 relative"><div id="monster-emoji" class="text-8xl md:text-9xl filter drop-shadow-2xl transition-transform cursor-pointer hover:scale-105 active:scale-90">üëæ</div><div id="damage-text" class="absolute top-0 left-1/2 -translate-x-1/2 text-red-500 font-bold text-4xl opacity-0 transition-all pointer-events-none">-20</div></div>
<div class="bg-gray-800/90 backdrop-blur p-6 rounded-xl border border-blue-500/30 shadow-2xl mb-6 w-full max-w-2xl text-center"><h3 id="q-word" class="text-4xl font-bold text-white mb-2">...</h3><p id="q-meaning" class="text-lg text-blue-300">...</p></div>
<div id="drop-zone" class="w-full max-w-3xl bg-gray-800/50 min-h-[80px] rounded-lg border-2 border-dashed border-gray-600 flex flex-wrap gap-2 p-3 items-center justify-center mb-6 transition-colors"><span class="text-gray-500 italic text-sm pointer-events-none">Tap words to attack...</span></div>
<div id="word-bank" class="w-full max-w-3xl flex flex-wrap justify-center gap-2"></div>
</div>
<div class="p-4 bg-gray-800 flex justify-center gap-4"><button id="btn-reset" class="bg-gray-600 px-6 py-3 rounded-lg font-bold">‚Ü∫ Reset</button><button id="btn-attack" class="bg-blue-600 px-10 py-3 rounded-lg font-bold text-lg shadow-lg border-b-4 border-blue-800 active:border-b-0 active:translate-y-1">ATTACK! ‚öîÔ∏è</button></div>
</div>

<div id="admin-view" class="view-section flex-col h-full w-full bg-slate-900 p-8 overflow-y-auto">
<div class="max-w-4xl mx-auto w-full">
<div class="flex justify-between items-center mb-8"><h2 class="text-3xl font-bold text-white">Parent Zone</h2><button id="btn-back-dash" class="bg-gray-700 px-4 py-2 rounded">‚Üê Back to Dashboard</button></div>
<div class="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-xl mb-8">
<h3 class="text-xl font-bold mb-4 text-blue-400">Add New Mission (Excel Upload)</h3>
<form id="upload-form" class="space-y-4">
<div><label class="block text-sm text-gray-400 mb-1">Mission Title</label><input type="text" name="title" placeholder="e.g. Chapter 1" class="w-full bg-slate-700 p-2 rounded text-white border border-slate-600" required></div>
<div><label class="block text-sm text-gray-400 mb-1">Difficulty</label><select name="difficulty" class="w-full bg-slate-700 p-2 rounded text-white border border-slate-600"><option value="Easy">Easy</option><option value="Normal">Normal</option><option value="Hard">Hard</option></select></div>
<div><label class="block text-sm text-gray-400 mb-1">Excel File</label><input type="file" name="file" accept=".xlsx" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700" required></div>
<button type="submit" id="upload-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg transition-colors">Upload Mission</button>
<p id="upload-status" class="text-center text-sm mt-2"></p>
</form>
</div>
<h3 class="text-xl font-bold mb-4">Existing Missions</h3>
<div id="admin-level-list" class="space-y-4"></div>
</div>
</div>

<script>
function setStatus(msg, color) { const el = document.getElementById("sys-status"); el.textContent = msg; el.className = `fixed top-0 left-0 w-full text-white text-xs font-bold p-1 z-50 text-center shadow-lg ${color}`; if(color.includes("green")) setTimeout(()=>el.style.display="none", 3000); }
let currentUser=null,currentLevel=null,battleWords=[],currentWordIndex=0,playerSelection=[],defeatedCount=0,GOAL_COUNT=5;
window.onload=function(){fetchUsers();};
function switchView(e){document.querySelectorAll(".view-section").forEach(e=>e.classList.remove("active")),document.getElementById(e).classList.add("active"),"dashboard-view"===e&&fetchLevels(),"admin-view"===e&&fetchAdminLevels()}
function showAddUserModal(){document.getElementById("add-user-modal").classList.remove("hidden")}
function closeAddUserModal(){document.getElementById("add-user-modal").classList.add("hidden")}
async function fetchUsers(){
    setStatus("üî¥ Connecting to Server...", "bg-red-600");
    try{
        let e=await fetch("/api/users");
        if(!e.ok) throw new Error("API Error");
        let t=await e.json(),n=document.getElementById("user-list");
        n.innerHTML="",t.length===0 ? n.innerHTML='<p class="text-gray-500">No players yet. Add one!</p>' : t.forEach(e=>{let t=document.createElement("div");t.className="card-hover bg-gray-800 p-6 rounded-xl border border-gray-600 cursor-pointer w-40 text-center transition-all hover:bg-gray-700 hover:border-blue-500",t.onclick=()=>selectUser(e),t.innerHTML=`<div class="text-5xl mb-4">${e.avatar}</div><div class="font-bold text-lg text-white">${e.name}</div><div class="text-xs text-yellow-500 pixel-font mt-2">LV.${e.level}</div>`,n.appendChild(t)});
        setStatus("üü¢ Online", "bg-green-600");
    }catch(e){ setStatus("‚ö†Ô∏è Offline: " + e.message, "bg-red-600"); }
}
async function createNewUser(){let e=document.getElementById("new-username").value;e&&(await fetch("/api/users",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name:e,avatar:["üë¶","üëß","üê∂","üê±","ü§ñ"][Math.floor(5*Math.random())]})}),closeAddUserModal(),fetchUsers())}
function selectUser(e){currentUser=e,document.getElementById("dash-avatar").textContent=e.avatar,document.getElementById("dash-name").textContent=e.name,document.getElementById("dash-level").textContent="LV."+e.level,switchView("dashboard-view")}
async function fetchLevels(){let e=await fetch("/api/levels"),t=await e.json(),n=document.getElementById("level-list");n.innerHTML="",0===t.length?document.getElementById("empty-levels-msg").classList.remove("hidden"):(document.getElementById("empty-levels-msg").classList.add("hidden"),t.forEach(e=>{let t=document.createElement("div"),l={"Easy":"border-green-500","Normal":"border-blue-500","Hard":"border-red-500"}[e.difficulty]||"border-gray-500";t.className=`card-hover bg-gray-800 p-6 rounded-xl border-l-4 ${l} cursor-pointer shadow-lg`,t.onclick=()=>startLevel(e),t.innerHTML=`<h3 class="font-bold text-xl text-white mb-2">${e.title}</h3><div class="flex justify-between items-center text-sm text-gray-400"><span>${e.difficulty}</span><span>${e.word_count} Words</span></div>`,n.appendChild(t)}))}
async function fetchAdminLevels(){let e=await fetch("/api/levels"),t=await e.json(),n=document.getElementById("admin-level-list");n.innerHTML="",t.forEach(e=>{let t=document.createElement("div");t.className="flex justify-between items-center bg-slate-700 p-4 rounded",t.innerHTML=`<div><span class="font-bold text-white">${e.title}</span> <span class="text-xs text-gray-400">(${e.word_count} words)</span></div><button onclick="deleteLevel(${e.id})" class="text-red-400 text-sm hover:text-red-300">Delete</button>`,n.appendChild(t)})}
async function deleteLevel(e){confirm("Delete this mission?")&&(await fetch(`/api/admin/levels/${e}`,{method:"DELETE"}),fetchAdminLevels())}
async function startLevel(e){currentLevel=e;let t=await fetch(`/api/game/start/${e.id}?count=${GOAL_COUNT}`);if(battleWords=await t.json(),0===battleWords.length){alert("This mission has no words!");return}currentWordIndex=0,defeatedCount=0,updateBattleStats(),switchView("game-view"),loadBattleWord(0)}
function loadBattleWord(e){if(e>=battleWords.length){finishBattle();return}let t=battleWords[e];document.getElementById("q-word").textContent=t.word,document.getElementById("q-meaning").textContent=t.meaning,document.getElementById("drop-zone").innerHTML='<span class="text-gray-500 italic text-sm pointer-events-none">Tap words...</span>',playerSelection=[];let n=t.sentence.trim().split(/\s+/),l=[...n].sort(()=>Math.random()-.5),a=document.getElementById("word-bank");a.innerHTML="",l.forEach(e=>{let t=document.createElement("button");t.className="bg-indigo-600 hover:bg-indigo-500 px-4 py-2 rounded shadow text-white font-bold transition-all",t.textContent=e,t.onclick=()=>{let n=document.createElement("span");n.className="bg-yellow-500 text-black px-2 py-1 rounded font-bold cursor-pointer hover:bg-red-400",n.textContent=e,n.onclick=()=>{n.remove(),playerSelection.splice(playerSelection.indexOf(e),1),t.classList.remove("opacity-20","pointer-events-none"),0===playerSelection.length&&(document.getElementById("drop-zone").innerHTML='<span class="text-gray-500 italic text-sm pointer-events-none">Tap words...</span>')},0===playerSelection.length&&(document.getElementById("drop-zone").innerHTML=""),document.getElementById("drop-zone").appendChild(n),playerSelection.push(e),t.classList.add("opacity-20","pointer-events-none")},a.appendChild(t)})}
function resetBattleSentence(){loadBattleWord(currentWordIndex)}
function submitAttack(){let e=battleWords[currentWordIndex].sentence.replace(/[^\w\s]/gi,"").toLowerCase().replace(/\s+/g,""),t=playerSelection.join("").replace(/[^\w\s]/gi,"").toLowerCase().replace(/\s+/g,"");if(e===t){let n=document.getElementById("monster-emoji");n.classList.add("shake"),document.getElementById("damage-text").style.opacity="1",document.getElementById("damage-text").style.top="-50px",setTimeout(()=>{n.classList.remove("shake"),document.getElementById("damage-text").style.opacity="0",document.getElementById("damage-text").style.top="0",defeatedCount++,currentWordIndex++,updateBattleStats(),loadBattleWord(currentWordIndex)},800)}else document.getElementById("drop-zone").classList.add("bg-red-900","shake"),setTimeout(()=>document.getElementById("drop-zone").classList.remove("bg-red-900","shake"),500)}
async function finishBattle(){alert("MISSION COMPLETE! Victory!");let e=100;await fetch(`/api/users/${currentUser.id}/progress?xp_gained=${e}`,{method:"POST"}),currentUser.xp+=e,switchView("dashboard-view")}
function updateBattleStats(){document.getElementById("monsters-killed").textContent=defeatedCount;let e=defeatedCount/GOAL_COUNT*100;document.getElementById("battle-progress").style.width=Math.min(e,100)+"%"}
function quitGame(){confirm("Abandon mission?")&&switchView("dashboard-view")}
document.getElementById("upload-form").onsubmit=async e=>{e.preventDefault();let t=document.getElementById("upload-btn"),n=document.getElementById("upload-status"),l=new FormData(e.target);t.disabled=!0,t.textContent="Uploading...",n.textContent="";try{let a=await fetch("/api/admin/upload",{method:"POST",body:l});if(a.ok){n.textContent="Success! Mission added.",n.className="text-center text-sm mt-2 text-green-400",e.target.reset(),fetchAdminLevels()}else{let o=await a.json();throw new Error(o.detail)}}catch(r){n.textContent="Error: "+r.message,n.className="text-center text-sm mt-2 text-red-400"}finally{t.disabled=!1,t.textContent="Upload Mission"}};
</script>
</body>
</html>
