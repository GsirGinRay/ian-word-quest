<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ians Game Console</title>
<style>
/* CSS Reset & Basic */
body { background-color: #111827; color: white; font-family: sans-serif; margin: 0; overflow: hidden; }
.hidden { display: none !important; }
.btn { padding: 15px 30px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; font-size: 16px; }
.btn-primary { background-color: #2563eb; color: white; }
.btn-secondary { background-color: #4b5563; color: white; border: 1px solid #9ca3af; }

/* Modal Styles (No Tailwind dependency) */
.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 50; display: flex; justify-content: center; align-items: center; }
.modal-box { background: #1f2937; padding: 25px; border-radius: 12px; width: 90%; max-width: 350px; border: 1px solid #374151; }
.input-field { width: 100%; padding: 10px; margin: 15px 0; border-radius: 6px; border: none; background: #374151; color: white; box-sizing: border-box;}

/* Views */
.view-section { display: none; height: 100vh; width: 100%; flex-direction: column; }
.view-section.active { display: flex; }
.center-content { align-items: center; justify-content: center; text-align: center; }

/* Status Bar */
#sys-status { position: fixed; top: 0; width: 100%; text-align: center; padding: 5px; font-size: 12px; z-index: 100; font-weight: bold;}
.status-red { background: #dc2626; color: white; }
.status-green { background: #16a34a; color: white; }
</style>
</head>
<body>
<div id="sys-status" class="status-red">üî¥ Connecting...</div>

<!-- 1. LOGIN -->
<div id="login-view" class="view-section active center-content">
    <h1 style="font-size: 40px; color: #facc15; margin-bottom: 20px;">IANS CONSOLE</h1>
    <p style="color: #d1d5db; font-size: 20px;">Who is playing?</p>
    
    <div id="user-list" style="display: flex; gap: 20px; flex-wrap: wrap; justify-content: center; padding: 20px;">
        <p style="color: gray">Loading...</p>
    </div>

    <div style="margin-top: 40px;">
        <button id="btn-add-player" class="btn btn-secondary">
            + Add New Player
        </button>
    </div>
</div>

<!-- MODAL (Manually styled) -->
<div id="add-user-modal" class="modal-overlay hidden">
    <div class="modal-box">
        <h3 style="margin: 0 0 15px 0; font-size: 24px;">New Hero</h3>
        <input type="text" id="new-username" placeholder="Enter Name" class="input-field">
        <div style="display: flex; justify-content: flex-end; gap: 10px;">
            <button id="btn-cancel-modal" class="btn btn-secondary" style="padding: 10px 20px;">Cancel</button>
            <button id="btn-create-user" class="btn btn-primary" style="padding: 10px 20px;">Create</button>
        </div>
    </div>
</div>

<!-- 2. DASHBOARD -->
<div id="dashboard-view" class="view-section">
    <div style="background: #1f2937; padding: 15px; display: flex; justify-content: space-between; align-items: center;">
        <div style="display: flex; align-items: center; gap: 15px;">
            <button id="btn-logout" style="background:none; border:none; color: #9ca3af; cursor: pointer;">‚Üê Logout</button>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span id="dash-avatar" style="font-size: 24px;">üë¶</span>
                <div>
                    <div id="dash-name" style="font-weight: bold;">Ian</div>
                    <div id="dash-level" style="font-size: 12px; color: #facc15;">LV.1</div>
                </div>
            </div>
        </div>
        <button id="btn-admin" style="background: #374151; border: none; color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px;">‚öôÔ∏è Parent Zone</button>
    </div>
    <div style="padding: 20px; overflow-y: auto; flex: 1;">
        <h2 style="border-left: 4px solid #eab308; padding-left: 15px; margin-bottom: 20px;">Mission Select</h2>
        <div id="level-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px;"></div>
        <div id="empty-levels-msg" class="hidden" style="text-align: center; color: gray; margin-top: 50px;">
            <p>No missions available yet.</p>
            <p>Go to Parent Zone to add missions!</p>
        </div>
    </div>
</div>

<!-- 3. GAME (Placeholder for structure) -->
<div id="game-view" class="view-section" style="background: #111827;">
    <div style="padding: 10px; background: #1f2937; display: flex; justify-content: space-between;">
        <button id="btn-quit-game" style="color: #f87171; background: none; border: none; font-weight: bold;">EXIT üè≥Ô∏è</button>
        <span style="color: #facc15">Battle</span>
    </div>
    <div class="center-content" style="flex: 1;">
        <div id="monster-emoji" style="font-size: 80px; cursor: pointer;">üëæ</div>
        <div style="background: #1f2937; padding: 20px; border-radius: 12px; margin: 20px; border: 1px solid #2563eb;">
            <h3 id="q-word" style="font-size: 32px; margin: 0;">...</h3>
            <p id="q-meaning" style="color: #93c5fd; font-size: 18px;">...</p>
        </div>
        <div id="drop-zone" style="min-height: 60px; border: 2px dashed #4b5563; margin: 20px; border-radius: 8px; padding: 10px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">
            Tap words...
        </div>
        <div id="word-bank" style="display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; padding: 10px;"></div>
    </div>
    <div style="padding: 20px; display: flex; justify-content: center; gap: 20px;">
        <button id="btn-reset" class="btn btn-secondary">Reset</button>
        <button id="btn-attack" class="btn btn-primary">ATTACK!</button>
    </div>
</div>

<!-- 4. ADMIN -->
<div id="admin-view" class="view-section">
    <div style="padding: 20px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
            <h2>Parent Zone</h2>
            <button id="btn-back-dashboard" class="btn btn-secondary" style="padding: 5px 15px;">Back</button>
        </div>
        <div style="background: #1f2937; padding: 20px; border-radius: 12px;">
            <h3>Upload Mission (Excel)</h3>
            <form id="upload-form">
                <input type="text" name="title" placeholder="Mission Title" class="input-field" required>
                <select name="difficulty" class="input-field"><option value="Normal">Normal</option></select>
                <input type="file" name="file" accept=".xlsx" class="input-field" required>
                <button type="submit" id="upload-btn" class="btn btn-primary" style="width: 100%;">Upload</button>
                <p id="upload-status" style="text-align: center; margin-top: 10px; font-size: 14px;"></p>
            </form>
        </div>
        <h3 style="margin-top: 30px;">Existing Missions</h3>
        <div id="admin-level-list"></div>
    </div>
</div>

<script>
// --- LOGIC ---
let currentUser=null,currentLevel=null,battleWords=[],currentWordIndex=0,playerSelection=[],defeatedCount=0,GOAL_COUNT=5;

function setStatus(msg, type) {
    var el = document.getElementById("sys-status");
    el.textContent = msg;
    el.className = type;
    if(type === "status-green") setTimeout(function() { el.style.display = "none"; }, 3000);
}

function showModal() {
    document.getElementById("add-user-modal").classList.remove("hidden");
}

function closeModal() {
    document.getElementById("add-user-modal").classList.add("hidden");
}

function switchView(id){
    document.querySelectorAll(".view-section").forEach(function(e) { e.classList.remove("active"); });
    document.getElementById(id).classList.add("active");
    if(id==="dashboard-view") fetchLevels();
    if(id==="admin-view") fetchAdminLevels();
}

async function fetchUsers(){
    setStatus("Connecting...", "status-red");
    try {
        var res = await fetch("/api/users");
        if(!res.ok) throw new Error("API Error");
        var users = await res.json();
        var container = document.getElementById("user-list");
        container.innerHTML = "";

        if(users.length === 0) container.innerHTML = '<p style="color:gray">No players yet. Click Add New Player!</p>';

        users.forEach(function(u) {
            var div = document.createElement("div");
            div.style.cssText = "background: #1f2937; padding: 20px; border-radius: 12px; cursor: pointer; border: 1px solid #374151; min-width: 100px;";
            div.addEventListener("click", function() { selectUser(u); });
            div.innerHTML = '<div style="font-size: 40px; margin-bottom: 10px;">'+u.avatar+'</div><div style="font-weight: bold;">'+u.name+'</div><div style="font-size: 12px; color: #facc15;">LV.'+u.level+'</div>';
            container.appendChild(div);
        });
        setStatus("System Online", "status-green");
    } catch(e) {
        setStatus("Offline: " + e.message, "status-red");
    }
}

async function createNewUser(){
    var name = document.getElementById("new-username").value;
    if(!name) return alert("Please enter a name");

    try {
        await fetch("/api/users", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ name: name })
        });
        document.getElementById("new-username").value = "";
        closeModal();
        fetchUsers();
    } catch(e) { alert("Create Failed: " + e.message); }
}

function selectUser(u){
    currentUser=u;
    document.getElementById("dash-avatar").textContent=u.avatar;
    document.getElementById("dash-name").textContent=u.name;
    document.getElementById("dash-level").textContent="LV."+u.level;
    switchView("dashboard-view");
}

async function fetchLevels(){
    var res = await fetch("/api/levels");
    var levels = await res.json();
    var container = document.getElementById("level-list");
    container.innerHTML = "";
    if(levels.length===0) document.getElementById("empty-levels-msg").classList.remove("hidden");
    else {
        document.getElementById("empty-levels-msg").classList.add("hidden");
        levels.forEach(function(l) {
            var div = document.createElement("div");
            div.style.cssText = "background: #1f2937; padding: 20px; border-radius: 12px; border-left: 4px solid #3b82f6; cursor: pointer;";
            div.addEventListener("click", function() { startLevel(l); });
            div.innerHTML = '<h3 style="margin:0 0 10px 0;">'+l.title+'</h3><div style="color:gray; font-size:14px;">'+l.word_count+' Words</div>';
            container.appendChild(div);
        });
    }
}

async function fetchAdminLevels(){
    var res = await fetch("/api/levels");
    var levels = await res.json();
    var container = document.getElementById("admin-level-list");
    container.innerHTML = "";
    levels.forEach(function(l) {
        var div = document.createElement("div");
        div.style.cssText = "display: flex; justify-content: space-between; padding: 10px; background: #374151; margin-bottom: 10px; border-radius: 6px;";

        var span = document.createElement("span");
        span.textContent = l.title;

        var btn = document.createElement("button");
        btn.textContent = "Delete";
        btn.style.cssText = "color: #f87171; background: none; border: none; cursor: pointer;";
        btn.addEventListener("click", function() { deleteLevel(l.id); });

        div.appendChild(span);
        div.appendChild(btn);
        container.appendChild(div);
    });
}

async function deleteLevel(id) {
    if(confirm("Delete?")) {
        await fetch("/api/admin/levels/"+id, {method:"DELETE"});
        fetchAdminLevels();
    }
}

async function startLevel(l) {
    currentLevel = l;
    var res = await fetch("/api/game/start/"+l.id+"?count="+GOAL_COUNT);
    battleWords = await res.json();
    if(battleWords.length === 0) return alert("No words in this mission!");

    currentWordIndex = 0; defeatedCount = 0; playerSelection = [];
    switchView("game-view");
    loadBattleWord(0);
}

function loadBattleWord(idx) {
    if(idx >= battleWords.length) return finishBattle();
    var w = battleWords[idx];
    document.getElementById("q-word").textContent = w.word;
    document.getElementById("q-meaning").textContent = w.meaning;

    var parts = w.sentence.trim().split(/\s+/).sort(function() { return Math.random() - 0.5; });
    var bank = document.getElementById("word-bank");
    bank.innerHTML = "";
    document.getElementById("drop-zone").innerHTML = '<span style="color:gray">Tap words...</span>';
    playerSelection = [];

    parts.forEach(function(word) {
        var btn = document.createElement("button");
        btn.textContent = word;
        btn.className = "btn btn-primary";
        btn.style.padding = "10px 15px";
        btn.addEventListener("click", function() {
            var span = document.createElement("span");
            span.textContent = word;
            span.style.cssText = "background: #eab308; color: black; padding: 5px 10px; border-radius: 4px; cursor: pointer;";
            span.addEventListener("click", function() {
                span.remove();
                playerSelection.splice(playerSelection.indexOf(word), 1);
                btn.style.opacity = "1"; btn.style.pointerEvents = "auto";
                if(playerSelection.length===0) document.getElementById("drop-zone").innerHTML='<span style="color:gray">Tap words...</span>';
            });

            if(playerSelection.length===0) document.getElementById("drop-zone").innerHTML="";
            document.getElementById("drop-zone").appendChild(span);
            playerSelection.push(word);
            btn.style.opacity = "0.5"; btn.style.pointerEvents = "none";
        });
        bank.appendChild(btn);
    });
}

function resetBattleSentence() { loadBattleWord(currentWordIndex); }

function submitAttack() {
    var target = battleWords[currentWordIndex].sentence.replace(/[^\w\s]/gi,"").toLowerCase().replace(/\s+/g,"");
    var player = playerSelection.join("").replace(/[^\w\s]/gi,"").toLowerCase().replace(/\s+/g,"");

    if(player === target) {
        alert("Correct! Attack!");
        defeatedCount++;
        currentWordIndex++;
        loadBattleWord(currentWordIndex);
    } else {
        alert("Wrong! Try again.");
        resetBattleSentence();
    }
}

async function finishBattle() {
    alert("Mission Complete! +100 XP");
    await fetch("/api/users/"+currentUser.id+"/progress?xp_gained=100", {method:"POST"});
    currentUser.xp += 100;
    switchView("dashboard-view");
}

function quitGame() { if(confirm("Quit?")) switchView("dashboard-view"); }

// Initialize when DOM is ready
document.addEventListener("DOMContentLoaded", function() {
    console.log("System V8 Loaded - Using addEventListener");

    // Bind all button events
    document.getElementById("btn-add-player").addEventListener("click", showModal);
    document.getElementById("btn-cancel-modal").addEventListener("click", closeModal);
    document.getElementById("btn-create-user").addEventListener("click", createNewUser);
    document.getElementById("btn-logout").addEventListener("click", function() { switchView("login-view"); });
    document.getElementById("btn-admin").addEventListener("click", function() { switchView("admin-view"); });
    document.getElementById("btn-quit-game").addEventListener("click", quitGame);
    document.getElementById("btn-reset").addEventListener("click", resetBattleSentence);
    document.getElementById("btn-attack").addEventListener("click", submitAttack);
    document.getElementById("btn-back-dashboard").addEventListener("click", function() { switchView("dashboard-view"); });

    // Admin Upload Form
    document.getElementById("upload-form").addEventListener("submit", async function(e) {
        e.preventDefault();
        var btn = document.getElementById("upload-btn");
        var status = document.getElementById("upload-status");
        var formData = new FormData(e.target);

        btn.disabled = true;
        btn.textContent = "Uploading...";
        status.textContent = "";

        try {
            var res = await fetch("/api/admin/upload", {method: "POST", body: formData});
            if(res.ok) {
                status.textContent = "Success!";
                status.style.color = "#4ade80";
                e.target.reset();
                fetchAdminLevels();
            } else {
                var data = await res.json();
                throw new Error(data.detail);
            }
        } catch(err) {
            status.textContent = "Error: " + err.message;
            status.style.color = "#f87171";
        } finally {
            btn.disabled = false;
            btn.textContent = "Upload";
        }
    });

    // Initial fetch
    fetchUsers();
});
</script>
</body>
</html>
