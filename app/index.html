<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Word Quest - å–®å­—å¤§å†’éšª</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
    background: linear-gradient(180deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
    color: white;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    min-height: 100vh;
    overflow: hidden;
}
.hidden { display: none !important; }

/* Views */
.view { display: none; min-height: 100vh; }
.view.active { display: flex; flex-direction: column; }

/* Buttons */
.btn {
    padding: 16px 32px;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    font-weight: bold;
    font-size: 18px;
    transition: all 0.15s;
    touch-action: manipulation;
}
.btn:active { transform: scale(0.95); }
.btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
.btn-attack { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; font-size: 22px; }
.btn-secondary { background: rgba(255,255,255,0.1); color: white; border: 2px solid rgba(255,255,255,0.3); }

/* Login */
#login-view { align-items: center; justify-content: center; padding: 20px; text-align: center; }
.game-logo { font-size: 64px; margin-bottom: 16px; animation: float 3s ease-in-out infinite; }
@keyframes float { 0%,100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
.game-title { font-size: 36px; background: linear-gradient(90deg, #f093fb, #f5576c, #ffecd2); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px; }
.game-subtitle { color: #a0a0a0; margin-bottom: 40px; }

.player-grid { display: flex; flex-wrap: wrap; gap: 16px; justify-content: center; margin-bottom: 32px; }
.player-card {
    background: rgba(255,255,255,0.1);
    padding: 24px 32px;
    border-radius: 16px;
    cursor: pointer;
    transition: all 0.2s;
    border: 3px solid transparent;
    min-width: 120px;
}
.player-card:hover { border-color: #f093fb; background: rgba(255,255,255,0.15); }
.player-card .avatar { font-size: 48px; }
.player-card .name { font-weight: bold; margin-top: 8px; }
.player-card .level { color: #ffd700; font-size: 14px; }

/* Modal */
.modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 20px; }
.modal-box { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); padding: 32px; border-radius: 20px; width: 100%; max-width: 360px; border: 2px solid #333; }
.modal-box h2 { margin-bottom: 24px; text-align: center; }
.modal-box input { width: 100%; padding: 16px; border-radius: 12px; border: 2px solid #333; background: #1a1a2e; color: white; font-size: 18px; margin-bottom: 20px; }
.modal-box input:focus { outline: none; border-color: #f093fb; }
.modal-buttons { display: flex; gap: 12px; }
.modal-buttons .btn { flex: 1; }

/* Dashboard */
#dashboard-view { padding: 20px; }
.dash-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
.player-info { display: flex; align-items: center; gap: 12px; background: rgba(255,255,255,0.1); padding: 12px 20px; border-radius: 50px; }
.player-info .avatar { font-size: 32px; }
.player-info .details .name { font-weight: bold; }
.player-info .details .stats { font-size: 14px; color: #ffd700; }

.section-title { font-size: 24px; margin-bottom: 16px; display: flex; align-items: center; gap: 12px; }
.level-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; }
.level-card {
    background: linear-gradient(135deg, rgba(102,126,234,0.4) 0%, rgba(118,75,162,0.4) 100%);
    padding: 20px;
    border-radius: 16px;
    text-align: center;
    cursor: pointer;
    transition: all 0.2s;
    border: 3px solid transparent;
}
.level-card:hover { border-color: #667eea; transform: translateY(-4px); }
.level-card.locked { opacity: 0.5; cursor: not-allowed; }
.level-card.locked .num { color: #666; }
.level-card.completed { background: linear-gradient(135deg, rgba(46,213,115,0.4) 0%, rgba(123,237,159,0.4) 100%); border-color: #2ed573; }
.level-card.completed .num { color: #2ed573; font-size: 24px; }
.level-card .num { font-size: 28px; font-weight: bold; color: #ffd700; }
.level-card .level-num { font-size: 14px; color: #fff; margin-top: 2px; }
.level-card .words { font-size: 12px; color: #aaa; margin-top: 4px; }

/* Battle View */
#battle-view { background: linear-gradient(180deg, #1a0a2e 0%, #2d1b4e 50%, #1a0a2e 100%); }

.battle-header {
    padding: 12px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: rgba(0,0,0,0.3);
}
.combo-display {
    background: linear-gradient(135deg, #f093fb, #f5576c);
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: bold;
    opacity: 0;
    transition: all 0.3s;
}
.combo-display.active { opacity: 1; animation: pulse 0.5s; }
@keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.1); } }

.battle-arena {
    flex: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: space-around;
    padding: 20px;
    position: relative;
    overflow: hidden;
}

/* Monster */
.monster-container { text-align: center; position: relative; }
.monster-hp-bar {
    width: 200px;
    height: 16px;
    background: #333;
    border-radius: 10px;
    overflow: hidden;
    margin: 0 auto 12px;
    border: 2px solid #555;
}
.monster-hp-fill {
    height: 100%;
    background: linear-gradient(90deg, #ff4757, #ff6b81);
    transition: width 0.3s;
}
.monster-emoji {
    font-size: 100px;
    transition: all 0.15s;
    cursor: default;
    filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5));
}
.monster-emoji.shake { animation: shake 0.3s; }
.monster-emoji.hurt { filter: brightness(2) drop-shadow(0 10px 20px rgba(255,0,0,0.5)); }
@keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-10px)} 75%{transform:translateX(10px)} }
.monster-name { font-size: 18px; color: #ff6b81; margin-top: 8px; }

/* Damage Numbers */
.damage-number {
    position: absolute;
    font-size: 36px;
    font-weight: bold;
    color: #ffd700;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    pointer-events: none;
    animation: damageFloat 1s forwards;
    z-index: 10;
}
@keyframes damageFloat {
    0% { opacity: 1; transform: translateY(0) scale(1); }
    100% { opacity: 0; transform: translateY(-80px) scale(1.5); }
}
.damage-number.miss { color: #888; font-size: 28px; }
.damage-number.critical { color: #ff4757; font-size: 48px; }

/* Question Area */
.question-area {
    width: 100%;
    max-width: 500px;
    text-align: center;
}
.word-display {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 24px 40px;
    border-radius: 20px;
    margin-bottom: 20px;
    box-shadow: 0 10px 30px rgba(102,126,234,0.4);
}
.word-english { font-size: 36px; font-weight: bold; }
.word-hint { color: rgba(255,255,255,0.7); font-size: 14px; margin-top: 8px; }

/* Sentence display */
.sentence-display {
    background: rgba(0,0,0,0.3);
    padding: 16px 20px;
    border-radius: 12px;
    margin-top: 16px;
    font-size: 14px;
    line-height: 1.6;
    text-align: left;
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    transition: all 0.3s;
}
.sentence-display.show {
    max-height: 200px;
    opacity: 1;
}

.choices-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.choice-btn {
    padding: 18px 12px;
    background: rgba(255,255,255,0.1);
    border: 3px solid rgba(255,255,255,0.2);
    border-radius: 16px;
    color: white;
    font-size: 18px;
    cursor: pointer;
    transition: all 0.15s;
    min-height: 70px;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    line-height: 1.3;
}
.choice-btn:hover { background: rgba(255,255,255,0.2); border-color: #667eea; }
.choice-btn:active { transform: scale(0.95); }
.choice-btn.correct { background: #2ed573 !important; border-color: #2ed573 !important; }
.choice-btn.wrong { background: #ff4757 !important; border-color: #ff4757 !important; }
.choice-btn:disabled { cursor: not-allowed; }

/* Player HP */
.player-status {
    width: 100%;
    max-width: 500px;
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    background: rgba(0,0,0,0.3);
    border-radius: 12px;
}
.player-avatar { font-size: 36px; }
.player-hp-bar {
    flex: 1;
    height: 20px;
    background: #333;
    border-radius: 10px;
    overflow: hidden;
}
.player-hp-fill {
    height: 100%;
    background: linear-gradient(90deg, #2ed573, #7bed9f);
    transition: width 0.3s;
}

/* Timer */
.timer-bar {
    width: 100%;
    height: 6px;
    background: #333;
    border-radius: 3px;
    overflow: hidden;
    margin-top: 12px;
}
.timer-fill {
    height: 100%;
    background: linear-gradient(90deg, #ffd700, #ffa502);
    transition: width 0.1s linear;
}

/* Victory/Defeat */
.result-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 50;
}
.result-box {
    text-align: center;
    padding: 40px;
}
.result-emoji { font-size: 100px; margin-bottom: 20px; }
.result-title { font-size: 36px; margin-bottom: 12px; }
.result-stats { color: #aaa; margin-bottom: 8px; }
.result-xp { font-size: 24px; color: #ffd700; margin-bottom: 32px; }

/* Effects */
.screen-flash {
    position: fixed;
    inset: 0;
    background: white;
    opacity: 0;
    pointer-events: none;
    z-index: 1000;
}
.screen-flash.active { animation: flash 0.15s; }
@keyframes flash { 0% { opacity: 0.5; } 100% { opacity: 0; } }
</style>
</head>
<body>

<div class="screen-flash" id="screen-flash"></div>

<!-- LOGIN -->
<div id="login-view" class="view active">
    <div class="game-logo">âš”ï¸</div>
    <h1 class="game-title">å–®å­—å¤§å†’éšª</h1>
    <p class="game-subtitle">Word Quest</p>

    <div id="player-grid" class="player-grid">
        <p style="color:#666">è¼‰å…¥ä¸­...</p>
    </div>

    <button id="btn-new-player" class="btn btn-secondary">âœ¨ å»ºç«‹æ–°è§’è‰²</button>
</div>

<!-- New Player Modal -->
<div id="modal-new-player" class="modal hidden">
    <div class="modal-box">
        <h2>ğŸ¦¸ å»ºç«‹è§’è‰²</h2>
        <input type="text" id="input-name" placeholder="è¼¸å…¥ä½ çš„åå­—">
        <div class="modal-buttons">
            <button id="btn-cancel" class="btn btn-secondary">å–æ¶ˆ</button>
            <button id="btn-create" class="btn btn-primary">é–‹å§‹å†’éšªï¼</button>
        </div>
    </div>
</div>

<!-- DASHBOARD -->
<div id="dashboard-view" class="view">
    <div class="dash-header">
        <button id="btn-logout" class="btn btn-secondary" style="padding:10px 16px;font-size:14px;">â† ç™»å‡º</button>
        <div class="player-info">
            <span id="info-avatar" class="avatar">ğŸ§™</span>
            <div class="details">
                <div id="info-name" class="name">Player</div>
                <div id="info-stats" class="stats">Lv.1 Â· 0 XP</div>
            </div>
        </div>
    </div>

    <div class="section-title">âš”ï¸ é¸æ“‡é—œå¡</div>
    <div id="level-grid" class="level-grid"></div>
</div>

<!-- BATTLE -->
<div id="battle-view" class="view">
    <div class="battle-header">
        <button id="btn-flee" class="btn btn-secondary" style="padding:8px 16px;font-size:14px;">ğŸƒ é€ƒè·‘</button>
        <div id="combo-display" class="combo-display">ğŸ”¥ COMBO x2</div>
        <div id="round-display" style="color:#ffd700;font-weight:bold;">1/5</div>
    </div>

    <div class="battle-arena">
        <div class="monster-container">
            <div class="monster-hp-bar">
                <div id="monster-hp-fill" class="monster-hp-fill" style="width:100%"></div>
            </div>
            <div id="monster-emoji" class="monster-emoji">ğŸ‘¹</div>
            <div id="monster-name" class="monster-name">å²èŠå§†</div>
        </div>

        <div class="question-area">
            <div class="word-display">
                <div id="word-english" class="word-english">apple</div>
                <div class="word-hint">é¸æ“‡æ­£ç¢ºçš„ä¸­æ–‡æ„æ€ä¾†æ”»æ“Šï¼</div>
                <div id="sentence-display" class="sentence-display"></div>
            </div>

            <div id="choices" class="choices-grid"></div>

            <div class="timer-bar">
                <div id="timer-fill" class="timer-fill" style="width:100%"></div>
            </div>
        </div>

        <div class="player-status">
            <span class="player-avatar">ğŸ§™</span>
            <div class="player-hp-bar">
                <div id="player-hp-fill" class="player-hp-fill" style="width:100%"></div>
            </div>
            <span id="player-hp-text" style="min-width:60px;text-align:right;">100/100</span>
        </div>
    </div>
</div>

<!-- Result Overlay -->
<div id="result-overlay" class="result-overlay hidden">
    <div class="result-box">
        <div id="result-emoji" class="result-emoji">ğŸ‰</div>
        <h2 id="result-title" class="result-title">å‹åˆ©ï¼</h2>
        <p id="result-accuracy" class="result-stats">æ­£ç¢ºç‡: 100%</p>
        <p id="result-combo" class="result-stats">æœ€é«˜é€£æ“Š: 5</p>
        <p id="result-xp" class="result-xp">+150 XP</p>
        <button id="btn-continue" class="btn btn-primary">ç¹¼çºŒå†’éšª</button>
    </div>
</div>

<script>
// ========== GAME STATE ==========
var currentUser = null;
var allWords = [];
var gameWords = [];
var currentRound = 0;
var combo = 0;
var maxCombo = 0;
var correctCount = 0;
var playerHP = 100;
var monsterHP = 100;
var timerInterval = null;
var timeLeft = 10;
var currentLevelId = null;

var MONSTERS = [
    { emoji: "ğŸŸ¢", name: "å²èŠå§†", hp: 60 },
    { emoji: "ğŸ‘»", name: "å¹½éˆ", hp: 80 },
    { emoji: "ğŸº", name: "é‡ç‹¼", hp: 100 },
    { emoji: "ğŸ§Ÿ", name: "æ®­å±", hp: 120 },
    { emoji: "ğŸ‘¹", name: "æƒ¡é­”", hp: 150 },
    { emoji: "ğŸ‰", name: "ç«é¾", hp: 200 },
];

// ========== UTILITIES ==========
function shuffle(arr) {
    var a = arr.slice();
    for (var i = a.length - 1; i > 0; i--) {
        var j = Math.floor(Math.random() * (i + 1));
        var t = a[i]; a[i] = a[j]; a[j] = t;
    }
    return a;
}

function switchView(id) {
    document.querySelectorAll(".view").forEach(function(v) { v.classList.remove("active"); });
    document.getElementById(id).classList.add("active");
}

function flashScreen() {
    var el = document.getElementById("screen-flash");
    el.classList.remove("active");
    void el.offsetWidth;
    el.classList.add("active");
}

function showDamage(amount, type) {
    var arena = document.querySelector(".battle-arena");
    var div = document.createElement("div");
    div.className = "damage-number" + (type ? " " + type : "");
    div.textContent = type === "miss" ? "MISS" : "-" + amount;
    div.style.left = (Math.random() * 100 + 100) + "px";
    div.style.top = (Math.random() * 50 + 50) + "px";
    arena.appendChild(div);
    setTimeout(function() { div.remove(); }, 1000);
}

// ========== API ==========
async function fetchUsers() {
    try {
        var res = await fetch("/api/users");
        var users = await res.json();
        var grid = document.getElementById("player-grid");
        grid.innerHTML = "";

        if (users.length === 0) {
            grid.innerHTML = '<p style="color:#666">é‚„æ²’æœ‰å‹‡è€…ï¼Œå»ºç«‹ä¸€å€‹å§ï¼</p>';
        } else {
            users.forEach(function(u) {
                var div = document.createElement("div");
                div.className = "player-card";
                div.innerHTML = '<div class="avatar">ğŸ§™</div><div class="name">' + u.name + '</div><div class="level">Lv.' + u.level + '</div>';
                div.addEventListener("click", function() { selectPlayer(u); });
                grid.appendChild(div);
            });
        }
    } catch (e) {
        document.getElementById("player-grid").innerHTML = '<p style="color:#f66">é€£ç·šå¤±æ•—</p>';
    }
}

async function createUser(name) {
    await fetch("/api/users", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: name })
    });
    fetchUsers();
}

async function fetchLevels() {
    var url = "/api/levels";
    if (currentUser) {
        url += "?user_id=" + currentUser.id;
    }
    var res = await fetch(url);
    var levels = await res.json();
    var grid = document.getElementById("level-grid");
    grid.innerHTML = "";

    levels.forEach(function(l, i) {
        var div = document.createElement("div");
        var statusIcon = l.completed ? "âœ“" : (l.unlocked ? "" : "ğŸ”’");
        var statusClass = l.completed ? "completed" : (l.unlocked ? "" : "locked");

        div.className = "level-card " + statusClass;
        div.innerHTML = '<div class="num">' + (statusIcon || l.id) + '</div>' +
                        '<div class="level-num">ç¬¬ ' + l.id + ' é—œ</div>' +
                        '<div class="words">' + l.word_count + 'å­—</div>';

        if (l.unlocked) {
            div.addEventListener("click", function() { startBattle(l); });
        } else {
            div.addEventListener("click", function() {
                alert("è«‹å…ˆå®Œæˆç¬¬ " + (l.id - 1) + " é—œï¼");
            });
        }
        grid.appendChild(div);
    });
}

async function fetchAllWords() {
    var res = await fetch("/api/words/all");
    allWords = await res.json();
}

// ========== GAME LOGIC ==========
function selectPlayer(u) {
    currentUser = u;
    document.getElementById("info-name").textContent = u.name;
    document.getElementById("info-stats").textContent = "Lv." + u.level + " Â· " + u.xp + " XP";
    switchView("dashboard-view");
    fetchLevels();
    fetchAllWords();
}

async function startBattle(level) {
    var res = await fetch("/api/game/start/" + level.id + "?count=5");
    gameWords = await res.json();

    if (gameWords.length === 0) {
        alert("é€™å€‹é—œå¡æ²’æœ‰å–®å­—ï¼");
        return;
    }

    // Reset game state
    currentLevelId = level.id;
    currentRound = 0;
    combo = 0;
    maxCombo = 0;
    correctCount = 0;
    playerHP = 100;

    // Pick a monster based on level
    var monsterIndex = Math.min(Math.floor(level.id / 5), MONSTERS.length - 1);
    var monster = MONSTERS[monsterIndex];
    monsterHP = monster.hp;

    document.getElementById("monster-emoji").textContent = monster.emoji;
    document.getElementById("monster-name").textContent = monster.name;
    document.getElementById("monster-hp-fill").style.width = "100%";
    document.getElementById("player-hp-fill").style.width = "100%";
    document.getElementById("player-hp-text").textContent = "100/100";

    switchView("battle-view");
    nextRound();
}

function nextRound() {
    if (currentRound >= gameWords.length || playerHP <= 0) {
        endBattle();
        return;
    }

    var word = gameWords[currentRound];
    document.getElementById("word-english").textContent = word.word;
    document.getElementById("round-display").textContent = (currentRound + 1) + "/" + gameWords.length;

    // Hide sentence display for new question
    document.getElementById("sentence-display").classList.remove("show");
    document.getElementById("sentence-display").textContent = "";

    // Update combo display
    var comboEl = document.getElementById("combo-display");
    if (combo >= 2) {
        comboEl.textContent = "ğŸ”¥ COMBO x" + combo;
        comboEl.classList.add("active");
    } else {
        comboEl.classList.remove("active");
    }

    // Generate 4 choices
    var choices = [{ text: word.meaning, correct: true }];
    var wrongWords = shuffle(allWords.filter(function(w) { return w.meaning !== word.meaning; }));
    for (var i = 0; i < 3 && i < wrongWords.length; i++) {
        choices.push({ text: wrongWords[i].meaning, correct: false });
    }
    while (choices.length < 4) {
        choices.push({ text: "???", correct: false });
    }
    choices = shuffle(choices);

    // Render choices
    var container = document.getElementById("choices");
    container.innerHTML = "";
    choices.forEach(function(c) {
        var btn = document.createElement("button");
        btn.className = "choice-btn";
        btn.textContent = c.text;
        btn.addEventListener("click", function() { handleAnswer(btn, c.correct, word.meaning); });
        container.appendChild(btn);
    });

    // Start timer
    startTimer();
}

function startTimer() {
    timeLeft = 10;
    document.getElementById("timer-fill").style.width = "100%";

    if (timerInterval) clearInterval(timerInterval);
    timerInterval = setInterval(function() {
        timeLeft -= 0.1;
        document.getElementById("timer-fill").style.width = (timeLeft / 10 * 100) + "%";

        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            handleTimeout();
        }
    }, 100);
}

function handleTimeout() {
    // Time's up = wrong answer
    handleAnswer(null, false, gameWords[currentRound].meaning);
}

function handleAnswer(btn, correct, correctAnswer) {
    clearInterval(timerInterval);

    // Disable all buttons
    var buttons = document.querySelectorAll(".choice-btn");
    buttons.forEach(function(b) { b.disabled = true; });

    // Show correct/wrong
    if (btn) {
        btn.classList.add(correct ? "correct" : "wrong");
    }

    // Highlight correct answer if wrong
    if (!correct) {
        buttons.forEach(function(b) {
            if (b.textContent === correctAnswer) b.classList.add("correct");
        });
    }

    // Show example sentence
    var word = gameWords[currentRound];
    if (word.sentence) {
        var sentenceEl = document.getElementById("sentence-display");
        sentenceEl.innerHTML = "ğŸ“– " + word.sentence;
        sentenceEl.classList.add("show");
    }

    var monsterEl = document.getElementById("monster-emoji");

    if (correct) {
        // Correct answer - attack monster!
        combo++;
        if (combo > maxCombo) maxCombo = combo;
        correctCount++;

        // Calculate damage (base + combo bonus + time bonus)
        var baseDamage = 20;
        var comboBonus = Math.min(combo - 1, 5) * 5; // up to +25 from combo
        var timeBonus = Math.floor(timeLeft * 2); // up to +20 from time
        var totalDamage = baseDamage + comboBonus + timeBonus;

        monsterHP -= totalDamage;
        if (monsterHP < 0) monsterHP = 0;

        // Visual effects
        flashScreen();
        monsterEl.classList.add("shake", "hurt");
        showDamage(totalDamage, combo >= 3 ? "critical" : "");

        document.getElementById("monster-hp-fill").style.width = (monsterHP / MONSTERS[0].hp * 100) + "%";

        setTimeout(function() {
            monsterEl.classList.remove("shake", "hurt");
        }, 300);

    } else {
        // Wrong answer - monster attacks player!
        combo = 0;
        var damage = 20;
        playerHP -= damage;
        if (playerHP < 0) playerHP = 0;

        showDamage(damage, "miss");
        document.getElementById("player-hp-fill").style.width = playerHP + "%";
        document.getElementById("player-hp-text").textContent = playerHP + "/100";
    }

    // Next round after delay (longer to read sentence)
    setTimeout(function() {
        currentRound++;
        nextRound();
    }, 2000);
}

async function endBattle() {
    var won = playerHP > 0;
    var accuracy = Math.round(correctCount / gameWords.length * 100);
    var xp = correctCount * 20 + maxCombo * 10;

    document.getElementById("result-emoji").textContent = won ? "ğŸ‰" : "ğŸ’€";
    document.getElementById("result-title").textContent = won ? "å‹åˆ©ï¼" : "æˆ°æ•—...";
    document.getElementById("result-accuracy").textContent = "æ­£ç¢ºç‡: " + accuracy + "%";
    document.getElementById("result-combo").textContent = "æœ€é«˜é€£æ“Š: " + maxCombo;
    document.getElementById("result-xp").textContent = "+" + xp + " XP";

    // Update XP and level completion
    var levelCompleted = false;
    if (currentUser) {
        var url = "/api/users/" + currentUser.id + "/progress?xp_gained=" + xp +
                  "&level_id=" + currentLevelId + "&score=" + accuracy;
        var res = await fetch(url, { method: "POST" });
        var data = await res.json();
        currentUser.xp = data.xp;
        currentUser.level = data.level;
        levelCompleted = data.level_completed;
        document.getElementById("info-stats").textContent = "Lv." + currentUser.level + " Â· " + currentUser.xp + " XP";
    }

    // Show unlock message if level completed
    if (levelCompleted) {
        document.getElementById("result-title").textContent = "ğŸŠ é—œå¡å®Œæˆï¼";
        document.getElementById("result-xp").textContent = "+" + xp + " XP\nğŸ”“ è§£é–ä¸‹ä¸€é—œï¼";
    }

    document.getElementById("result-overlay").classList.remove("hidden");
}

// ========== EVENT LISTENERS ==========
document.addEventListener("DOMContentLoaded", function() {
    // Login
    document.getElementById("btn-new-player").addEventListener("click", function() {
        document.getElementById("modal-new-player").classList.remove("hidden");
        document.getElementById("input-name").focus();
    });

    document.getElementById("btn-cancel").addEventListener("click", function() {
        document.getElementById("modal-new-player").classList.add("hidden");
    });

    document.getElementById("btn-create").addEventListener("click", function() {
        var name = document.getElementById("input-name").value.trim();
        if (!name) return alert("è«‹è¼¸å…¥åå­—ï¼");
        createUser(name);
        document.getElementById("modal-new-player").classList.add("hidden");
        document.getElementById("input-name").value = "";
    });

    // Dashboard
    document.getElementById("btn-logout").addEventListener("click", function() {
        currentUser = null;
        switchView("login-view");
    });

    // Battle
    document.getElementById("btn-flee").addEventListener("click", function() {
        if (confirm("ç¢ºå®šè¦é€ƒè·‘å—ï¼Ÿ")) {
            clearInterval(timerInterval);
            switchView("dashboard-view");
        }
    });

    // Result
    document.getElementById("btn-continue").addEventListener("click", function() {
        document.getElementById("result-overlay").classList.add("hidden");
        switchView("dashboard-view");
        fetchLevels(); // Refresh to show newly unlocked levels
    });

    // Init
    fetchUsers();
});
</script>
</body>
</html>
