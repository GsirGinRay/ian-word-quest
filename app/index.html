<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Word Quest V13 - ÂñÆÂ≠óÂ§ßÂÜíÈö™</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: linear-gradient(180deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .hidden {
            display: none !important;
        }

        /* Views */
        .view {
            display: none;
            min-height: 100vh;
        }

        .view.active {
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        /* Buttons */
        .btn {
            padding: 16px 32px;
            border-radius: 12px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 18px;
            transition: all 0.15s;
            touch-action: manipulation;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-attack {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            font-size: 22px;
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .btn-sound {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 200;
            padding: 10px 14px;
            font-size: 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
        }

        /* Login */
        #login-view {
            align-items: center;
            justify-content: center;
            padding: 20px;
            text-align: center;
        }

        .game-logo {
            font-size: 64px;
            margin-bottom: 16px;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .game-title {
            font-size: 36px;
            background: linear-gradient(90deg, #f093fb, #f5576c, #ffecd2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }

        .game-subtitle {
            color: #a0a0a0;
            margin-bottom: 40px;
        }

        .player-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            justify-content: center;
            margin-bottom: 32px;
        }

        .player-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 24px 32px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s;
            border: 3px solid transparent;
            min-width: 120px;
        }

        .player-card:hover {
            border-color: #f093fb;
            background: rgba(255, 255, 255, 0.15);
        }

        border-color: #f093fb;
        background: rgba(255, 255, 255, 0.15);
        }

        .player-card .avatar {
            font-size: 48px;
        }

        .player-card .name {
            font-weight: bold;
            margin-top: 8px;
        }

        .player-card .level {
            color: #ffd700;
            font-size: 14px;
        }

        .player-card {
            position: relative;
        }

        .player-card .btn-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: none;
            background: rgba(255, 71, 87, 0.8);
            color: white;
            font-size: 14px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .player-card:hover .btn-delete {
            opacity: 1;
        }

        .player-card .btn-delete:hover {
            background: #ff4757;
            transform: scale(1.1);
        }

        /* Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 20px;
        }

        .modal-box {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 32px;
            border-radius: 20px;
            width: 100%;
            max-width: 360px;
            border: 2px solid #333;
        }

        .modal-box h2 {
            margin-bottom: 24px;
            text-align: center;
        }

        .modal-box input {
            width: 100%;
            padding: 16px;
            border-radius: 12px;
            border: 2px solid #333;
            background: #1a1a2e;
            color: white;
            font-size: 18px;
            margin-bottom: 20px;
        }

        .modal-box input:focus {
            outline: none;
            border-color: #f093fb;
        }

        .modal-buttons {
            display: flex;
            gap: 12px;
        }

        .modal-buttons .btn {
            flex: 1;
        }

        /* Dashboard */
        #dashboard-view {
            padding: 20px;
        }

        .dash-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .player-info {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.1);
            padding: 12px 20px;
            border-radius: 50px;
        }

        .player-info .avatar {
            font-size: 32px;
        }

        .player-info .details .name {
            font-weight: bold;
        }

        .player-info .details .stats {
            font-size: 14px;
            color: #ffd700;
        }

        .section-title {
            font-size: 24px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .level-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 12px;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            padding-bottom: 20px;
        }

        .level-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.4) 0%, rgba(118, 75, 162, 0.4) 100%);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            border: 3px solid transparent;
        }

        .level-card:hover {
            border-color: #667eea;
            transform: translateY(-4px);
        }

        .level-card.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .level-card.locked .num {
            color: #666;
        }

        .level-card.completed {
            background: linear-gradient(135deg, rgba(46, 213, 115, 0.4) 0%, rgba(123, 237, 159, 0.4) 100%);
            border-color: #2ed573;
        }

        .level-card.completed .num {
            color: #2ed573;
            font-size: 24px;
        }

        .level-card .num {
            font-size: 28px;
            font-weight: bold;
            color: #ffd700;
        }

        .level-card .level-num {
            font-size: 14px;
            color: #fff;
            margin-top: 2px;
        }

        .level-card .words {
            font-size: 12px;
            color: #aaa;
            margin-top: 4px;
        }

        .level-card .mastery-bar {
            width: 100%;
            height: 6px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }

        .level-card .mastery-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #f39c12);
            border-radius: 3px;
            transition: width 0.3s;
        }

        .level-card .mastery-text {
            font-size: 11px;
            color: #ffd700;
            margin-top: 4px;
        }

        /* Review Button */
        .review-btn {
            background: linear-gradient(135deg, #ff9f43 0%, #ee5a24 100%);
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            color: white;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 16px;
        }

        .review-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Battle View */
        #battle-view {
            background: linear-gradient(180deg, #1a0a2e 0%, #2d1b4e 50%, #1a0a2e 100%);
            min-height: 100vh;
            height: auto;
        }

        .battle-header {
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.3);
        }

        .combo-display {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            opacity: 0;
            transition: all 0.3s;
        }

        .combo-display.active {
            opacity: 1;
            animation: pulse 0.5s;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .battle-arena {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
            padding: 20px;
            position: relative;
            overflow: visible;
            background:
                radial-gradient(circle at 20% 30%, rgba(102, 126, 234, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(118, 75, 162, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(240, 147, 251, 0.08) 0%, transparent 60%);
        }

        /* Star particles in battle arena */
        .battle-arena::before {
            content: "‚ú¶ ‚úß ‚ãÜ ‚úµ";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 100%;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.1);
            letter-spacing: 40px;
            word-spacing: 80px;
            line-height: 80px;
            overflow: hidden;
            pointer-events: none;
            animation: twinkle 4s ease-in-out infinite;
        }

        @keyframes twinkle {

            0%,
            100% {
                opacity: 0.3;
            }

            50% {
                opacity: 0.6;
            }
        }

        /* Monster */
        .monster-container {
            text-align: center;
            position: relative;
        }

        .monster-hp-bar {
            width: 200px;
            height: 16px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
            margin: 0 auto 12px;
            border: 2px solid #555;
        }

        .monster-hp-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4757, #ff6b81);
            transition: width 0.3s;
        }

        .monster-stage {
            position: relative;
            display: inline-block;
            padding: 20px 40px;
        }

        .monster-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: radial-gradient(circle, var(--monster-color, #ff6b81) 0%, transparent 70%);
            opacity: 0.4;
            animation: monsterPulse 2s ease-in-out infinite;
            z-index: 0;
        }

        @keyframes monsterPulse {

            0%,
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0.4;
            }

            50% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 0.6;
            }
        }

        .monster-emoji {
            font-size: 100px;
            transition: all 0.15s;
            cursor: default;
            filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.4));
            position: relative;
            z-index: 1;
            animation: monsterFloat 3s ease-in-out infinite;
            text-shadow: 0 0 30px var(--monster-color, #ff6b81);
        }

        @keyframes monsterFloat {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .monster-emoji.shake {
            animation: shake 0.3s;
        }

        .monster-emoji.hurt {
            filter: brightness(2) drop-shadow(0 10px 30px var(--monster-color, rgba(255, 0, 0, 0.7)));
            animation: hurt 0.3s;
            text-shadow: 0 0 50px #fff, 0 0 80px var(--monster-color, #ff6b81);
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0)
            }

            25% {
                transform: translateX(-10px)
            }

            75% {
                transform: translateX(10px)
            }
        }

        @keyframes hurt {

            0%,
            100% {
                transform: scale(1)
            }

            50% {
                transform: scale(0.9)
            }
        }

        .monster-name {
            font-size: 18px;
            color: #ff6b81;
            margin-top: 8px;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .monster-level {
            font-size: 12px;
            color: #ffd700;
            margin-top: 4px;
        }

        /* Damage Numbers */
        .damage-number {
            position: absolute;
            font-size: 36px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            pointer-events: none;
            animation: damageFloat 1s forwards;
            z-index: 10;
        }

        @keyframes damageFloat {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }

            100% {
                opacity: 0;
                transform: translateY(-80px) scale(1.5);
            }
        }

        .damage-number.miss {
            color: #888;
            font-size: 28px;
        }

        .damage-number.critical {
            color: #ff4757;
            font-size: 48px;
        }

        /* Question Area */
        .question-area {
            width: 100%;
            max-width: 500px;
            text-align: center;
        }

        .question-type-badge {
            display: inline-block;
            background: linear-gradient(135deg, #00b894, #00cec9);
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            margin-bottom: 12px;
            font-weight: bold;
        }

        .word-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 24px 40px;
            border-radius: 20px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .word-english {
            font-size: 36px;
            font-weight: bold;
        }

        .word-chinese {
            font-size: 28px;
            color: #ffeaa7;
            margin-top: 8px;
        }

        .word-hint {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
            margin-top: 8px;
        }

        /* Play Sound Button */
        .play-sound-btn {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            margin: 10px 0;
            transition: all 0.2s;
        }

        .play-sound-btn:hover {
            transform: scale(1.05);
        }

        .play-sound-btn:active {
            transform: scale(0.95);
        }

        /* Fill Blank Sentence */
        .fillblank-sentence {
            font-size: 18px;
            line-height: 1.8;
            padding: 16px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .fillblank-sentence .blank {
            display: inline-block;
            min-width: 80px;
            border-bottom: 3px solid #ffd700;
            margin: 0 4px;
        }

        /* Sentence display */
        .sentence-display {
            background: rgba(0, 0, 0, 0.3);
            padding: 16px 20px;
            border-radius: 12px;
            margin-top: 16px;
            font-size: 14px;
            line-height: 1.6;
            text-align: left;
            max-height: 0;
            overflow: hidden;
            opacity: 0;
            transition: all 0.3s;
        }

        .sentence-display.show {
            max-height: 200px;
            opacity: 1;
        }

        .choices-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .choice-btn {
            padding: 18px 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-radius: 16px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.15s;
            min-height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1.3;
        }

        .choice-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: #667eea;
        }

        .choice-btn:active {
            transform: scale(0.95);
        }

        .choice-btn.correct {
            background: #2ed573 !important;
            border-color: #2ed573 !important;
        }

        .choice-btn.wrong {
            background: #ff4757 !important;
            border-color: #ff4757 !important;
        }

        .choice-btn:disabled {
            cursor: not-allowed;
        }

        /* Spell Input */
        .spell-input-area {
            margin: 16px 0;
        }

        .spell-display {
            font-size: 32px;
            letter-spacing: 8px;
            padding: 16px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 12px;
            min-height: 60px;
            font-family: monospace;
        }

        .spell-display .cursor {
            animation: blink 1s infinite;
            border-right: 3px solid #ffd700;
        }

        @keyframes blink {

            0%,
            50% {
                opacity: 1;
            }

            51%,
            100% {
                opacity: 0;
            }
        }

        /* Virtual Keyboard */
        .virtual-keyboard {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 16px;
            max-width: 100%;
        }

        .keyboard-row {
            display: flex;
            justify-content: center;
            gap: 4px;
        }

        .key-btn {
            min-width: 32px;
            height: 44px;
            background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.1s;
        }

        .key-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        .key-btn:active {
            transform: scale(0.9);
            background: #667eea;
        }

        .key-btn.wide {
            min-width: 60px;
            font-size: 14px;
        }

        .key-btn.submit {
            background: linear-gradient(135deg, #2ed573, #7bed9f);
            min-width: 80px;
        }

        .key-btn.hint {
            background: linear-gradient(135deg, #ffd700, #ffa502);
            min-width: 80px;
        }

        /* Player HP */
        .player-status {
            width: 100%;
            max-width: 500px;
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
        }

        .player-avatar {
            font-size: 36px;
        }

        .player-hp-bar {
            flex: 1;
            height: 20px;
            background: #333;
            border-radius: 10px;
            overflow: hidden;
        }

        .player-hp-fill {
            height: 100%;
            background: linear-gradient(90deg, #2ed573, #7bed9f);
            transition: width 0.3s;
        }

        /* Timer */
        .timer-bar {
            width: 100%;
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 12px;
        }

        .timer-fill {
            height: 100%;
            background: linear-gradient(90deg, #ffd700, #ffa502);
            transition: width 0.1s linear;
        }

        /* Victory/Defeat */
        .result-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .result-box {
            text-align: center;
            padding: 40px;
        }

        .result-emoji {
            font-size: 100px;
            margin-bottom: 20px;
        }

        .result-title {
            font-size: 36px;
            margin-bottom: 12px;
        }

        .result-stats {
            color: #aaa;
            margin-bottom: 8px;
        }

        .result-xp {
            font-size: 24px;
            color: #ffd700;
            margin-bottom: 32px;
            white-space: pre-line;
        }

        /* Effects */
        .screen-flash {
            position: fixed;
            inset: 0;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 1000;
        }

        .screen-flash.active {
            animation: flash 0.15s;
        }

        @keyframes flash {
            0% {
                opacity: 0.5;
            }

            100% {
                opacity: 0;
            }
        }

        /* Particle effects */
        .particle {
            position: absolute;
            pointer-events: none;
            animation: particleFade 1s forwards;
        }

        @keyframes particleFade {
            0% {
                opacity: 1;
                transform: scale(1);
            }

            100% {
                opacity: 0;
                transform: scale(0);
            }
        }

        /* Mastery stars */
        .mastery-stars {
            color: #ffd700;
            font-size: 12px;
            margin-top: 4px;
        }

        /* Player title */
        .player-title {
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.3);
            margin-top: 2px;
            display: inline-block;
        }

        /* Avatar selector */
        .avatar-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            margin: 16px 0;
        }

        .avatar-option {
            font-size: 40px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 3px solid transparent;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .avatar-option:hover {
            border-color: #667eea;
            transform: scale(1.1);
        }

        .avatar-option.selected {
            border-color: #f39c12;
            background: rgba(243, 156, 18, 0.2);
        }

        .avatar-option.locked {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .avatar-option .lock-badge {
            position: absolute;
            bottom: -5px;
            right: -5px;
            font-size: 16px;
        }

        /* Level up overlay */
        .levelup-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 200;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .levelup-box {
            text-align: center;
            padding: 40px;
            animation: scaleIn 0.5s ease-out;
        }

        @keyframes scaleIn {
            from {
                transform: scale(0.5);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .levelup-stars {
            font-size: 40px;
            animation: starBurst 1s ease-out;
        }

        @keyframes starBurst {
            0% {
                transform: scale(0);
            }

            50% {
                transform: scale(1.3);
            }

            100% {
                transform: scale(1);
            }
        }

        .levelup-number {
            font-size: 80px;
            font-weight: bold;
            background: linear-gradient(135deg, #f39c12, #e74c3c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 16px 0;
        }

        .levelup-title {
            font-size: 24px;
            margin-bottom: 24px;
        }

        .levelup-rewards {
            background: rgba(255, 255, 255, 0.1);
            padding: 16px 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            text-align: left;
        }

        .levelup-reward-item {
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .levelup-reward-item:last-child {
            border-bottom: none;
        }

        .reward-new {
            color: #2ecc71;
        }

        /* Bonus indicator */
        .bonus-badge {
            display: inline-block;
            background: linear-gradient(135deg, #f39c12, #e67e22);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            margin-left: 8px;
            font-weight: bold;
        }

        /* Word Browser Modal */
        .word-browser {
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .word-browser h2 {
            margin-bottom: 8px;
        }

        .word-browser .subtitle {
            color: #aaa;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .word-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .word-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            border-left: 4px solid #667eea;
        }

        .word-item.mastered {
            border-left-color: #2ed573;
        }

        .word-item .word-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .word-item .english {
            font-size: 20px;
            font-weight: bold;
            color: #fff;
        }

        .word-item .status {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
        }

        .word-item .status.mastered {
            background: rgba(46, 213, 115, 0.3);
            color: #2ed573;
        }

        .word-item .chinese {
            font-size: 16px;
            color: #ffeaa7;
            margin-bottom: 8px;
        }

        .word-item .sentence {
            font-size: 14px;
            color: #aaa;
            font-style: italic;
            line-height: 1.5;
        }

        .word-item .btn-speak {
            background: #3498db;
            border: none;
            padding: 4px 10px;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            margin-left: 8px;
        }

        /* ========== READING MODE ========== */
        #reading-list-view {
            padding: 20px;
        }

        #reading-view {
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            padding: 0;
        }

        .reading-header {
            padding: 16px 20px;
            background: rgba(0, 0, 0, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .reading-progress {
            font-size: 14px;
            color: #aaa;
        }

        .lexile-badge {
            background: linear-gradient(135deg, #667eea, #764ba2);
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
        }

        .passage-container {
            padding: 20px;
            max-width: 700px;
            margin: 0 auto;
        }

        .passage-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 16px;
            color: #fff;
        }

        .passage-content {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            font-size: 18px;
            line-height: 1.8;
            color: #e0e0e0;
            margin-bottom: 20px;
            white-space: pre-line;
        }

        .passage-tools {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .passage-tools .btn {
            padding: 10px 16px;
            font-size: 14px;
        }

        .vocab-panel {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .vocab-panel h4 {
            color: #ffd700;
            margin-bottom: 12px;
        }

        .vocab-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .vocab-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
        }

        .vocab-item:hover {
            background: rgba(255, 215, 0, 0.2);
        }

        .vocab-item .word {
            color: #fff;
            font-weight: bold;
        }

        .vocab-item .meaning {
            color: #aaa;
            margin-left: 6px;
        }

        .question-panel {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        .question-number {
            font-size: 12px;
            color: #667eea;
            margin-bottom: 8px;
        }

        .question-text {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 16px;
            color: #fff;
        }

        .question-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .option-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 14px 16px;
            text-align: left;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .option-btn:hover {
            background: rgba(102, 126, 234, 0.3);
            border-color: #667eea;
        }

        .option-btn.selected {
            background: rgba(102, 126, 234, 0.4);
            border-color: #667eea;
        }

        .option-btn.correct {
            background: rgba(46, 213, 115, 0.3);
            border-color: #2ed573;
        }

        .option-btn.wrong {
            background: rgba(255, 71, 87, 0.3);
            border-color: #ff4757;
        }

        .option-label {
            font-weight: bold;
            margin-right: 10px;
            color: #667eea;
        }

        .explanation-box {
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid #667eea;
            padding: 12px 16px;
            margin-top: 12px;
            border-radius: 0 8px 8px 0;
            font-size: 14px;
            color: #aaa;
        }

        .reading-result {
            text-align: center;
            padding: 40px 20px;
        }

        .reading-result .score {
            font-size: 48px;
            font-weight: bold;
            color: #2ed573;
        }

        .reading-result .detail {
            font-size: 18px;
            color: #aaa;
            margin: 16px 0;
        }

        .reading-result .lexile-change {
            font-size: 16px;
            color: #ffd700;
            margin-bottom: 24px;
        }

        /* Passage list */
        .passage-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            padding-bottom: 20px;
        }

        .passage-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3) 0%, rgba(118, 75, 162, 0.3) 100%);
            padding: 20px;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .passage-card:hover {
            border-color: #667eea;
            transform: translateY(-4px);
        }

        .passage-card.completed {
            border-color: #2ed573;
        }

        .passage-card .title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .passage-card .meta {
            font-size: 14px;
            color: #aaa;
        }

        .passage-card .score-badge {
            display: inline-block;
            background: #2ed573;
            color: #000;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-top: 8px;
        }

        /* Mode selector tabs */
        .mode-tabs {
            display: flex;
            gap: 0;
            margin-bottom: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 4px;
        }

        .mode-tab {
            flex: 1;
            padding: 12px 20px;
            border: none;
            background: transparent;
            color: #aaa;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .mode-tab.active {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: #fff;
        }

        .mode-tab:hover:not(.active) {
            color: #fff;
        }

        .level-card .btn-browse {
            position: absolute;
            bottom: 8px;
            right: 8px;
            background: rgba(102, 126, 234, 0.8);
            border: none;
            padding: 4px 8px;
            border-radius: 6px;
            color: white;
            font-size: 11px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .level-card:hover .btn-browse {
            opacity: 1;
        }

        .level-card .btn-browse:hover {
            background: #667eea;
        }

        /* ========== MOBILE RESPONSIVE ========== */
        @media screen and (max-height: 700px) {

            /* Compact monster display */
            .monster-emoji {
                font-size: 70px;
            }

            .monster-stage {
                padding: 10px 30px;
            }

            .monster-glow {
                width: 100px;
                height: 100px;
            }

            .monster-hp-bar {
                width: 150px;
                height: 12px;
                margin-bottom: 8px;
            }

            .monster-name {
                font-size: 14px;
                margin-top: 4px;
            }

            .monster-level {
                font-size: 10px;
            }

            /* Compact question area */
            .word-display {
                padding: 16px 24px;
                margin-bottom: 12px;
            }

            .word-english {
                font-size: 28px;
            }

            .word-chinese {
                font-size: 22px;
            }

            .question-type-badge {
                padding: 4px 12px;
                font-size: 12px;
                margin-bottom: 8px;
            }

            /* Smaller choices */
            .choices-grid {
                gap: 8px;
            }

            .choice-btn {
                padding: 12px 8px;
                font-size: 16px;
                min-height: 50px;
            }

            /* Compact player status */
            .player-status {
                padding: 8px 12px;
            }

            .player-avatar {
                font-size: 28px;
            }

            .player-hp-bar {
                height: 16px;
            }

            /* Compact keyboard */
            .key-btn {
                min-width: 28px;
                height: 38px;
                font-size: 16px;
            }

            .spell-display {
                font-size: 26px;
                padding: 12px;
                min-height: 50px;
            }

            /* Battle arena spacing */
            .battle-arena {
                padding: 12px;
                justify-content: space-between;
            }

            .battle-header {
                padding: 8px 16px;
            }
        }

        @media screen and (max-height: 600px) {

            /* Extra compact for very small screens */
            .monster-emoji {
                font-size: 50px;
            }

            .monster-stage {
                padding: 5px 20px;
            }

            .monster-glow {
                width: 80px;
                height: 80px;
            }

            .word-display {
                padding: 12px 16px;
                margin-bottom: 8px;
            }

            .word-english {
                font-size: 24px;
            }

            .choice-btn {
                padding: 10px 6px;
                font-size: 14px;
                min-height: 44px;
            }

            .timer-bar {
                margin-top: 8px;
            }
        }

        @media screen and (max-width: 380px) {

            /* Narrow phones */
            .key-btn {
                min-width: 26px;
                height: 36px;
                font-size: 14px;
            }

            .key-btn.wide {
                min-width: 50px;
                font-size: 12px;
            }

            .choice-btn {
                font-size: 14px;
                padding: 10px 6px;
            }

            .word-english {
                font-size: 24px;
            }
        }
    </style>
</head>

<body>

    <button id="btn-sound" class="btn btn-sound" title="Èü≥ÊïàÈñãÈóú">üîä</button>
    <div class="screen-flash" id="screen-flash"></div>

    <!-- LOGIN -->
    <div id="login-view" class="view active">
        <div class="game-logo">‚öîÔ∏è</div>
        <h1 class="game-title">ÂñÆÂ≠óÂ§ßÂÜíÈö™</h1>
        <p class="game-subtitle">Word Quest V13</p>

        <div id="player-grid" class="player-grid">
            <p style="color:#666">ËºâÂÖ•‰∏≠...</p>
        </div>

        <button id="btn-new-player" class="btn btn-secondary">‚ú® Âª∫Á´ãÊñ∞ËßíËâ≤</button>
    </div>

    <!-- New Player Modal -->
    <div id="modal-new-player" class="modal hidden">
        <div class="modal-box">
            <h2>ü¶∏ Âª∫Á´ãËßíËâ≤</h2>
            <input type="text" id="input-name" placeholder="Ëº∏ÂÖ•‰Ω†ÁöÑÂêçÂ≠ó">
            <div class="modal-buttons">
                <button id="btn-cancel" class="btn btn-secondary">ÂèñÊ∂à</button>
                <button id="btn-create" class="btn btn-primary">ÈñãÂßãÂÜíÈö™ÔºÅ</button>
            </div>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard-view" class="view">
        <div class="dash-header">
            <button id="btn-logout" class="btn btn-secondary" style="padding:10px 16px;font-size:14px;">‚Üê ÁôªÂá∫</button>
            <div class="player-info" id="player-info-box" style="cursor:pointer;" title="ÈªûÊìäÊõ¥ÊèõÈ†≠ÂÉè">
                <span id="info-avatar" class="avatar" style="font-size:40px;">üßí</span>
                <div class="details">
                    <div id="info-name" class="name">Player</div>
                    <div id="info-stats" class="stats">Lv.1 ¬∑ 0 XP</div>
                    <div id="info-title" class="player-title">üê£ ÂñÆÂ≠óÊñ∞Êâã</div>
                </div>
            </div>
        </div>

        <div class="dashboard-container" style="text-align:center;">
            <div class="menu-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:20px;">
                <div class="menu-card" onclick="switchView('world-map-view'); fetchWorlds();"
                    style="background:rgba(255,255,255,0.1); padding:20px; border-radius:16px; cursor:pointer;">
                    <div class="menu-icon" style="font-size:40px; margin-bottom:10px;">üåç</div>
                    <h3>ÂÜíÈö™Âú∞Âúñ</h3>
                    <p style="font-size:12px; color:#ccc;">Êé¢Á¥¢ 5 Â§ß‰∏ñÁïåÔºåÊåëÊà∞Èñ±ËÆÄÈóúÂç°</p>
                </div>
                <div class="menu-card" onclick="switchView('level-select-view'); fetchLevels();"
                    style="background:rgba(255,255,255,0.1); padding:20px; border-radius:16px; cursor:pointer;">
                    <div class="menu-icon" style="font-size:40px; margin-bottom:10px;">‚öîÔ∏è</div>
                    <h3>ÂñÆÂ≠óÊà∞È¨•</h3>
                    <p style="font-size:12px; color:#ccc;">ËàáÊÄ™Áâ©Êà∞È¨•ÔºåÂ≠∏ÁøíÊñ∞ÂñÆÂ≠ó</p>
                </div>
                <div class="menu-card" onclick="alert('ÊéíË°åÊ¶úÂäüËÉΩÂç≥Â∞áÈñãÊîæÔºÅ')"
                    style="background:rgba(255,255,255,0.1); padding:20px; border-radius:16px; cursor:pointer;">
                    <div class="menu-icon" style="font-size:40px; margin-bottom:10px;">üèÜ</div>
                    <h3>ÊéíË°åÊ¶ú</h3>
                    <p style="font-size:12px; color:#ccc;">Êü•ÁúãÂ•ΩÂèãËàáÂÖ®ÁêÉÊéíÂêç</p>
                </div>
                <div class="menu-card" onclick="alert('ÂïÜÂ∫óËàáËÉåÂåÖÂç≥Â∞áÈñãÊîæÔºÅ')"
                    style="background:rgba(255,255,255,0.1); padding:20px; border-radius:16px; cursor:pointer;">
                    <div class="menu-icon" style="font-size:40px; margin-bottom:10px;">üéí</div>
                    <h3>ËÉåÂåÖ</h3>
                    <p style="font-size:12px; color:#ccc;">Êü•ÁúãË£ùÂÇôËàáÊî∂ÈõÜÂìÅ</p>
                </div>
            </div>
        </div>
    </div>

    <!-- NEW: World Map View -->
    <div id="world-map-view" class="view hidden">
        <div class="header" style="padding:20px; display:flex; justify-content:space-between; align-items:center;">
            <button class="back-btn btn btn-secondary" onclick="switchView('dashboard-view')">‚Üê ËøîÂõûÂ§ßÂª≥</button>
            <h1 style="margin:0; font-size:24px;">ÂÜíÈö™‰∏ñÁïå</h1>
            <div style="width:80px;"></div>
        </div>

        <div id="world-map-container" class="world-map-container">
            <div class="loading">ËºâÂÖ•‰∏ñÁïåÂú∞Âúñ‰∏≠...</div>
        </div>
    </div>

    <!-- NEW: Stage Select View -->
    <div id="stage-select-view" class="view hidden">
        <div class="header" style="padding:20px; display:flex; justify-content:space-between; align-items:center;">
            <button class="back-btn btn btn-secondary" onclick="switchView('world-map-view')">‚Üê ËøîÂõûÂú∞Âúñ</button>
            <div style="text-align:center;">
                <h2 id="selected-world-title" style="margin:0;">‰∏ñÁïåÊ®ôÈ°å</h2>
                <span id="selected-world-lexile" class="tag"
                    style="background:#4CAF50; padding:2px 8px; border-radius:4px; font-size:12px;">350L - 450L</span>
            </div>
            <div style="width:80px;"></div>
        </div>

        <div class="content-box" style="padding:20px;">
            <div id="stage-list" class="stage-map-grid">
                <!-- Stages injected here -->
            </div>
        </div>
    </div>

    <!-- NEW: Level Select View (Vocabulary Battle) -->
    <div id="level-select-view" class="view hidden" style="padding:20px;">
        <div class="header"
            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <button class="back-btn btn btn-secondary" onclick="switchView('dashboard-view')">‚Üê ËøîÂõûÂ§ßÂª≥</button>
            <h3>ÂñÆÂ≠óÈóúÂç°</h3>
            <button id="btn-review" class="review-btn hidden">Ë§áÁøíÂº±Èªû</button>
        </div>
        <div id="level-grid" class="level-grid"></div>
    </div>

    <!-- BATTLE -->
    <div id="battle-view" class="view">
        <div class="battle-header">
            <button id="btn-flee" class="btn btn-secondary" style="padding:8px 16px;font-size:14px;">üèÉ ÈÄÉË∑ë</button>
            <div id="combo-display" class="combo-display">üî• COMBO x2</div>
            <div id="round-display" style="color:#ffd700;font-weight:bold;">1/5</div>
        </div>

        <div class="battle-arena">
            <div class="monster-container">
                <div class="monster-hp-bar">
                    <div id="monster-hp-fill" class="monster-hp-fill" style="width:100%"></div>
                </div>
                <div id="monster-stage" class="monster-stage">
                    <div id="monster-glow" class="monster-glow"></div>
                    <div id="monster-emoji" class="monster-emoji">üëπ</div>
                </div>
                <div id="monster-name" class="monster-name">Âè≤ËêäÂßÜ</div>
                <div id="monster-level" class="monster-level"></div>
            </div>

            <div class="question-area">
                <div id="question-type-badge" class="question-type-badge">üéØ ÈÅ∏ÊìáÈ°å</div>
                <div class="word-display">
                    <div id="word-english" class="word-english">apple</div>
                    <div id="word-chinese" class="word-chinese hidden"></div>
                    <div id="word-hint" class="word-hint">ÈÅ∏ÊìáÊ≠£Á¢∫ÁöÑ‰∏≠ÊñáÊÑèÊÄù‰æÜÊîªÊìäÔºÅ</div>
                    <button id="play-sound-btn" class="play-sound-btn hidden">üîä Êí≠ÊîæÁôºÈü≥</button>
                    <div id="fillblank-sentence" class="fillblank-sentence hidden"></div>
                    <div id="sentence-display" class="sentence-display"></div>
                </div>

                <div id="spell-input-area" class="spell-input-area hidden">
                    <div id="spell-display" class="spell-display"></div>
                    <div class="virtual-keyboard">
                        <div class="keyboard-row">
                            <button class="key-btn" data-key="Q">Q</button>
                            <button class="key-btn" data-key="W">W</button>
                            <button class="key-btn" data-key="E">E</button>
                            <button class="key-btn" data-key="R">R</button>
                            <button class="key-btn" data-key="T">T</button>
                            <button class="key-btn" data-key="Y">Y</button>
                            <button class="key-btn" data-key="U">U</button>
                            <button class="key-btn" data-key="I">I</button>
                            <button class="key-btn" data-key="O">O</button>
                            <button class="key-btn" data-key="P">P</button>
                        </div>
                        <div class="keyboard-row">
                            <button class="key-btn" data-key="A">A</button>
                            <button class="key-btn" data-key="S">S</button>
                            <button class="key-btn" data-key="D">D</button>
                            <button class="key-btn" data-key="F">F</button>
                            <button class="key-btn" data-key="G">G</button>
                            <button class="key-btn" data-key="H">H</button>
                            <button class="key-btn" data-key="J">J</button>
                            <button class="key-btn" data-key="K">K</button>
                            <button class="key-btn" data-key="L">L</button>
                        </div>
                        <div class="keyboard-row">
                            <button class="key-btn hint" data-key="HINT">üí°ÊèêÁ§∫</button>
                            <button class="key-btn" data-key="Z">Z</button>
                            <button class="key-btn" data-key="X">X</button>
                            <button class="key-btn" data-key="C">C</button>
                            <button class="key-btn" data-key="V">V</button>
                            <button class="key-btn" data-key="B">B</button>
                            <button class="key-btn" data-key="N">N</button>
                            <button class="key-btn" data-key="M">M</button>
                            <button class="key-btn wide" data-key="BACK">‚å´</button>
                        </div>
                        <div class="keyboard-row">
                            <button class="key-btn submit wide" data-key="ENTER">Á¢∫Ë™ç ‚úì</button>
                        </div>
                    </div>
                </div>

                <div id="choices" class="choices-grid"></div>

                <div class="timer-bar">
                    <div id="timer-fill" class="timer-fill" style="width:100%"></div>
                </div>
            </div>

            <div class="player-status">
                <span class="player-avatar">üßô</span>
                <div class="player-hp-bar">
                    <div id="player-hp-fill" class="player-hp-fill" style="width:100%"></div>
                </div>
                <span id="player-hp-text" style="min-width:60px;text-align:right;">100/100</span>
            </div>
        </div>
    </div>

    <!-- READING VIEW -->
    <div id="reading-view" class="view">
        <div class="reading-header">
            <button id="btn-reading-back" class="btn btn-secondary" style="padding:8px 16px;font-size:14px;">‚Üê
                ËøîÂõû</button>
            <div id="reading-lexile" class="lexile-badge">350L</div>
            <div id="reading-progress" class="reading-progress">È°åÁõÆ 1/4</div>
        </div>

        <div class="passage-container">
            <!-- Boss Overlay (Only shown for boss battles) -->
            <div id="boss-overlay" class="boss-overlay hidden">
                <img id="boss-avatar-battle" class="boss-avatar-battle" src="" alt="Boss">
                <div style="font-weight:bold; font-size:12px; margin-top:4px;" id="boss-name-battle">Boss Name</div>
                <div class="boss-hp-bar">
                    <div id="boss-hp-fill" class="boss-hp-fill" style="width:100%;"></div>
                </div>
                <div style="font-size:10px; color:#666;">HP: <span id="boss-hp-text">100/100</span></div>
            </div>

            <!-- Passage Content (shown during reading) -->
            <div id="passage-section">
                <div id="passage-image-container" style="text-align:center;margin-bottom:20px;">
                    <img id="passage-image" src="" alt="Passage Image"
                        style="max-width:100%;border-radius:12px;display:none;box-shadow:0 4px 12px rgba(0,0,0,0.3);">
                </div>
                <h2 id="passage-title" class="passage-title">The Red Ball</h2>
                <div id="passage-content" class="passage-content">Loading...</div>

                <div class="passage-tools">
                    <button id="btn-read-aloud" class="btn btn-secondary">üîä ÊúóËÆÄÂÖ®Êñá</button>
                    <button id="btn-show-vocab" class="btn btn-secondary">üìù Êü•ÁúãÁîüË©û</button>
                </div>

                <div id="vocab-panel" class="vocab-panel hidden">
                    <h4>üìö Êú¨ÊñáÁîüË©û</h4>
                    <div id="vocab-list" class="vocab-list"></div>
                </div>

                <button id="btn-start-questions" class="btn btn-primary" style="width:100%;margin-top:16px;">ÈñãÂßãÁ≠îÈ°å
                    ‚Üí</button>
            </div>

            <!-- Questions Section (shown during quiz) -->
            <div id="questions-section" class="hidden">
                <div id="question-container"></div>

                <div id="question-nav" style="display:flex;gap:12px;margin-top:20px;">
                    <button id="btn-prev-q" class="btn btn-secondary" style="flex:1;" disabled>‚Üê ‰∏ä‰∏ÄÈ°å</button>
                    <button id="btn-next-q" class="btn btn-primary" style="flex:1;">‰∏ã‰∏ÄÈ°å ‚Üí</button>
                </div>
            </div>

            <!-- Results Section (shown after completion) -->
            <div id="reading-result-section" class="hidden">
                <div class="reading-result">
                    <div class="result-emoji" style="font-size:64px;margin-bottom:16px;">üìñ</div>
                    <div id="reading-score" class="score">80%</div>
                    <div id="reading-detail" class="detail">Á≠îÂ∞ç 4 / 5 È°å</div>
                    <div id="reading-lexile-change" class="lexile-change"></div>
                    <div id="reading-xp" style="color:#ffd700;font-size:18px;margin-bottom:24px;">+60 XP</div>
                    <button id="btn-review-answers" class="btn btn-secondary" style="margin-bottom:12px;">üìã
                        Êü•ÁúãÁ≠îÊ°àËß£Êûê</button>
                    <button id="btn-reading-done" class="btn btn-primary">ÂÆåÊàê ‚úì</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Level Up Overlay -->
    <div id="levelup-overlay" class="levelup-overlay hidden">
        <div class="levelup-box">
            <div class="levelup-stars">‚≠ê‚ú®üåü‚ú®‚≠ê</div>
            <div id="levelup-text" style="font-size:24px;color:#f39c12;">Á≠âÁ¥öÊèêÂçáÔºÅ</div>
            <div id="levelup-number" class="levelup-number">Lv.5</div>
            <div id="levelup-title" class="levelup-title">üê• ÂñÆÂ≠óÂ≠∏Âæí</div>
            <div id="levelup-rewards" class="levelup-rewards">
                <div class="levelup-reward-item">üéÅ Áç≤ÂæóÊñ∞Á®±Ëôü</div>
            </div>
            <button id="btn-levelup-close" class="btn btn-primary">Â§™Ê£í‰∫ÜÔºÅ</button>
        </div>
    </div>

    <!-- Avatar Selection Modal -->
    <div id="modal-avatar" class="modal hidden">
        <div class="modal-box" style="max-width:400px;">
            <h2>üé≠ ÈÅ∏ÊìáÈ†≠ÂÉè</h2>
            <div id="avatar-selector" class="avatar-selector"></div>
            <div class="modal-buttons">
                <button id="btn-avatar-close" class="btn btn-primary" style="width:100%;">Á¢∫ÂÆö</button>
            </div>
        </div>
    </div>

    <!-- Word Browser Modal -->
    <div id="modal-words" class="modal hidden">
        <div class="modal-box word-browser">
            <h2 id="words-title">üìö ÂñÆÂ≠óÂàóË°®</h2>
            <p id="words-subtitle" class="subtitle">Á¨¨ 1 Èóú ¬∑ 50 ÂÄãÂñÆÂ≠ó</p>
            <div id="word-list" class="word-list">
                <!-- Words will be inserted here -->
            </div>
            <div class="modal-buttons" style="margin-top:20px;">
                <button id="btn-words-close" class="btn btn-primary" style="width:100%;">ÈóúÈñâ</button>
            </div>
        </div>
    </div>

    <!-- Result Overlay -->
    <div id="result-overlay" class="result-overlay hidden">
        <div class="result-box">
            <div id="result-emoji" class="result-emoji">üéâ</div>
            <h2 id="result-title" class="result-title">ÂãùÂà©ÔºÅ</h2>
            <p id="result-accuracy" class="result-stats">Ê≠£Á¢∫Áéá: 100%</p>
            <p id="result-combo" class="result-stats">ÊúÄÈ´òÈÄ£Êìä: 5</p>
            <p id="result-xp" class="result-xp">+150 XP</p>
            <button id="btn-continue" class="btn btn-primary">ÁπºÁ∫åÂÜíÈö™</button>
        </div>
    </div>

    <script>
        // ========== GAME STATE ==========
        var currentUser = null;
        var allWords = [];
        var gameWords = [];
        var currentRound = 0;
        var combo = 0;
        var maxCombo = 0;
        var correctCount = 0;
        var playerHP = 100;
        var monsterHP = 100;
        var monsterMaxHP = 100;
        var timerInterval = null;
        var timeLeft = 10;
        var currentLevelId = null;
        var isReviewMode = false;
        var soundEnabled = true;
        var spellInput = "";
        var currentQuestion = null;
        var hintsUsed = 0;
        var totalSpeedBonus = 0;  // Track speed bonus XP
        var questionStartTime = 0; // Track when question started

        // ========== READING MODE STATE ==========
        var currentPassage = null;
        var readingQuestions = [];
        var currentReadingQuestion = 0;
        var readingAnswers = {};
        var userLexile = 350;

        // Question types by difficulty
        // 'listen' = ËÅΩÈü≥Ëæ®Â≠ó (easiest - just hear and pick)
        // 'wordmatch' = Ë™çË≠òÂñÆÂ≠ó (see word + hear, pick matching)
        // 'fillblank' = Âè•Â≠êÂ°´Á©∫ (read sentence, pick word)
        // 'spell' = ÊãºÂØ´ÊåëÊà∞ (hardest - type the word)
        var ALL_QUESTION_TYPES = ['listen', 'wordmatch', 'fillblank', 'spell'];

        // Get available question types based on level
        // Note: Most words don't have Chinese meanings, so we focus on listening/spelling
        function getQuestionTypesForLevel(levelId) {
            if (levelId <= 10) {
                // Levels 1-10: Listen only (easiest - just hear and pick)
                return ['listen'];
            } else if (levelId <= 20) {
                // Levels 11-20: Listen + See English pick English (word recognition)
                return ['listen', 'wordmatch'];
            } else if (levelId <= 30) {
                // Levels 21-30: Add fill blank (uses sentences)
                return ['listen', 'wordmatch', 'fillblank'];
            } else {
                // Levels 31+: Add spelling (hardest)
                return ['listen', 'wordmatch', 'fillblank', 'spell'];
            }
        }

        var MONSTERS = [
            { emoji: "ü¶†", name: "ÈªèÊ∂≤ÊÄ™", hp: 60, color: "#2ecc71" },
            { emoji: "üêô", name: "Á´†È≠öÂ¶ñ", hp: 80, color: "#9b59b6" },
            { emoji: "ü¶á", name: "ËùôËù†Áéã", hp: 100, color: "#34495e" },
            { emoji: "üê∫", name: "ÊöóÂ§úÁãº", hp: 100, color: "#7f8c8d" },
            { emoji: "üëª", name: "ÂπΩÈùà", hp: 120, color: "#ecf0f1" },
            { emoji: "üßü", name: "ÊÆ≠Â±ç", hp: 120, color: "#27ae60" },
            { emoji: "üëπ", name: "Ëµ§È¨º", hp: 150, color: "#e74c3c" },
            { emoji: "üë∫", name: "Â§©Áãó", hp: 150, color: "#c0392b" },
            { emoji: "üê≤", name: "ÈùíÈæç", hp: 180, color: "#3498db" },
            { emoji: "üî•", name: "ÁÅ´ÁÑ∞È≠î", hp: 200, color: "#e67e22" },
            { emoji: "üêâ", name: "ÊöóÈªëÈæçÁéã", hp: 250, color: "#8e44ad" },
            { emoji: "üíÄ", name: "È™∑È´èÁéã", hp: 300, color: "#2c3e50" },
        ];

        // ========== LEVEL REWARD SYSTEM ==========
        // Titles based on player level
        var TITLES = [
            { minLevel: 1, title: "üê£ ÂñÆÂ≠óÊñ∞Êâã", color: "#aaa" },
            { minLevel: 5, title: "üê• ÂñÆÂ≠óÂ≠∏Âæí", color: "#f1c40f" },
            { minLevel: 10, title: "ü¶ä ÂñÆÂ≠óÈ´òÊâã", color: "#e67e22" },
            { minLevel: 15, title: "ü¶Å ÂñÆÂ≠óÂãáËÄÖ", color: "#e74c3c" },
            { minLevel: 20, title: "üê≤ ÂñÆÂ≠óÂ§ßÂ∏´", color: "#9b59b6" },
            { minLevel: 30, title: "üëë ÂñÆÂ≠óÁéãËÄÖ", color: "#f39c12" }
        ];

        // Avatars unlocked at certain levels
        var AVATARS = [
            { emoji: "üßí", name: "Â∞èÊúãÂèã", unlockLevel: 1 },
            { emoji: "ü¶∏", name: "Ë∂ÖÁ¥öËã±ÈõÑ", unlockLevel: 5 },
            { emoji: "ü•∑", name: "ÂøçËÄÖ", unlockLevel: 10 },
            { emoji: "üßù", name: "Á≤æÈùà", unlockLevel: 15 },
            { emoji: "ü¶Ñ", name: "Áç®ËßíÁç∏", unlockLevel: 20 },
            { emoji: "üëë", name: "ÂúãÁéã", unlockLevel: 30 }
        ];

        function getTitle(level) {
            var title = TITLES[0];
            for (var i = TITLES.length - 1; i >= 0; i--) {
                if (level >= TITLES[i].minLevel) {
                    title = TITLES[i];
                    break;
                }
            }
            return title;
        }

        function getUnlockedAvatars(level) {
            return AVATARS.filter(function (a) { return level >= a.unlockLevel; });
        }

        function getTimeBonus(level) {
            // Every 5 levels = +1 second
            return Math.floor(level / 5);
        }

        function getXPBonus(level) {
            // Every 10 levels = +10% XP
            return Math.floor(level / 10) * 0.1;
        }

        // ========== SOUND SYSTEM ==========
        var audioContext = null;

        function initAudio() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.log("Web Audio API not supported");
                }
            }
        }

        function speakWord(word) {
            if (!soundEnabled) return;
            if ('speechSynthesis' in window) {
                // Cancel any ongoing speech
                speechSynthesis.cancel();
                var utterance = new SpeechSynthesisUtterance(word);
                utterance.lang = 'en-US';
                utterance.rate = 0.8;
                utterance.pitch = 1;
                speechSynthesis.speak(utterance);
            }
        }

        function playSound(type) {
            if (!soundEnabled || !audioContext) return;

            // Resume audio context if suspended (required for mobile)
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            var oscillator = audioContext.createOscillator();
            var gainNode = audioContext.createGain();
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            var now = audioContext.currentTime;

            if (type === 'correct') {
                // Rising tone for correct answer
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(523.25, now); // C5
                oscillator.frequency.setValueAtTime(659.25, now + 0.1); // E5
                oscillator.frequency.setValueAtTime(783.99, now + 0.2); // G5
                gainNode.gain.setValueAtTime(0.3, now);
                gainNode.gain.exponentialDecayTo && gainNode.gain.exponentialDecayTo(0.01, now + 0.4);
                gainNode.gain.setValueAtTime(0.3, now);
                gainNode.gain.linearRampToValueAtTime(0.01, now + 0.4);
                oscillator.start(now);
                oscillator.stop(now + 0.4);
            } else if (type === 'wrong') {
                // Falling tone for wrong answer
                oscillator.type = 'sawtooth';
                oscillator.frequency.setValueAtTime(300, now);
                oscillator.frequency.linearRampToValueAtTime(150, now + 0.3);
                gainNode.gain.setValueAtTime(0.2, now);
                gainNode.gain.linearRampToValueAtTime(0.01, now + 0.3);
                oscillator.start(now);
                oscillator.stop(now + 0.3);
            } else if (type === 'attack') {
                // Attack sound
                oscillator.type = 'square';
                oscillator.frequency.setValueAtTime(200, now);
                oscillator.frequency.linearRampToValueAtTime(400, now + 0.05);
                oscillator.frequency.linearRampToValueAtTime(100, now + 0.15);
                gainNode.gain.setValueAtTime(0.3, now);
                gainNode.gain.linearRampToValueAtTime(0.01, now + 0.2);
                oscillator.start(now);
                oscillator.stop(now + 0.2);
            } else if (type === 'levelup') {
                // Level up fanfare
                var notes = [523.25, 659.25, 783.99, 1046.50];
                notes.forEach(function (freq, i) {
                    var osc = audioContext.createOscillator();
                    var gain = audioContext.createGain();
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(freq, now + i * 0.15);
                    gain.gain.setValueAtTime(0.3, now + i * 0.15);
                    gain.gain.linearRampToValueAtTime(0.01, now + i * 0.15 + 0.3);
                    osc.start(now + i * 0.15);
                    osc.stop(now + i * 0.15 + 0.3);
                });
            } else if (type === 'click') {
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(800, now);
                gainNode.gain.setValueAtTime(0.1, now);
                gainNode.gain.linearRampToValueAtTime(0.01, now + 0.05);
                oscillator.start(now);
                oscillator.stop(now + 0.05);
            }
        }

        function toggleSound() {
            soundEnabled = !soundEnabled;
            document.getElementById("btn-sound").textContent = soundEnabled ? "üîä" : "üîá";
        }

        // ========== UTILITIES ==========
        // Check if a meaning is just a part of speech (not actual meaning)
        var POS_WORDS = ['ÂêçË©û', 'ÂãïË©û', 'ÂâØË©û', 'ÂΩ¢ÂÆπË©û', '‰ªãË©û', 'ÈÄ£Êé•Ë©û', '‰ª£ÂêçË©û', 'ÊÑüÂòÜË©û', 'ÂÜ†Ë©û'];
        function isPartOfSpeech(meaning) {
            if (!meaning) return true;
            return POS_WORDS.indexOf(meaning.trim()) !== -1;
        }

        // Get display meaning - use word itself if meaning is just POS
        function getDisplayMeaning(word) {
            if (isPartOfSpeech(word.meaning)) {
                // If meaning is just POS, return the English word with hint
                return word.word + ' (?)';
            }
            return word.meaning;
        }

        function shuffle(arr) {
            var a = arr.slice();
            for (var i = a.length - 1; i > 0; i--) {
                var j = Math.floor(Math.random() * (i + 1));
                var t = a[i]; a[i] = a[j]; a[j] = t;
            }
            return a;
        }

        function switchView(viewId) {
            // STOP TIMERS to prevent performance leaks
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }

            document.querySelectorAll(".view").forEach(function (el) {
                el.classList.remove("active");
                el.classList.add("hidden"); // Ensure everything is hidden
            });
            var target = document.getElementById(viewId);
            if (target) {
                target.classList.remove("hidden");
                target.classList.add("active");
            }
        }

        function flashScreen() {
            var el = document.getElementById("screen-flash");
            el.classList.remove("active");
            void el.offsetWidth;
            el.classList.add("active");
        }

        function showDamage(amount, type) {
            var arena = document.querySelector(".battle-arena");
            var div = document.createElement("div");
            div.className = "damage-number" + (type ? " " + type : "");
            div.textContent = type === "miss" ? "MISS" : "-" + amount;
            div.style.left = (Math.random() * 100 + 100) + "px";
            div.style.top = (Math.random() * 50 + 50) + "px";
            arena.appendChild(div);
            setTimeout(function () { div.remove(); }, 1000);
        }

        function createParticles(x, y, color, count) {
            var arena = document.querySelector(".battle-arena");
            for (var i = 0; i < count; i++) {
                var particle = document.createElement("div");
                particle.className = "particle";
                particle.style.left = x + "px";
                particle.style.top = y + "px";
                particle.style.width = "10px";
                particle.style.height = "10px";
                particle.style.background = color;
                particle.style.borderRadius = "50%";
                var angle = (Math.PI * 2 / count) * i;
                var distance = 50 + Math.random() * 50;
                particle.style.transform = "translate(" + (Math.cos(angle) * distance) + "px, " + (Math.sin(angle) * distance) + "px)";
                arena.appendChild(particle);
                setTimeout(function () { particle.remove(); }, 1000);
            }
        }

        // ========== CONFUSING WORD SELECTION ==========
        // Pick words that are likely to confuse the player
        function getConfusingWords(correctWord, count) {
            var correct = correctWord.toLowerCase();
            var firstLetter = correct.charAt(0);
            var wordLength = correct.length;
            var candidates = [];

            // Score each word by how confusing it is
            allWords.forEach(function (w) {
                if (w.word.toLowerCase() === correct) return;
                if (w.word.length < 2) return;

                var word = w.word.toLowerCase();
                var score = 0;

                // Same first letter = very confusing (+30 points)
                if (word.charAt(0) === firstLetter) {
                    score += 30;
                }

                // Similar length = confusing (+20 points for exact, +10 for ¬±1, +5 for ¬±2)
                var lengthDiff = Math.abs(word.length - wordLength);
                if (lengthDiff === 0) score += 20;
                else if (lengthDiff === 1) score += 10;
                else if (lengthDiff === 2) score += 5;

                // Same ending = confusing (+15 points)
                if (word.length >= 2 && correct.length >= 2) {
                    if (word.slice(-2) === correct.slice(-2)) score += 15;
                    else if (word.slice(-1) === correct.slice(-1)) score += 8;
                }

                // Contains similar letter patterns (+10 points)
                var commonLetters = 0;
                for (var i = 0; i < correct.length; i++) {
                    if (word.indexOf(correct[i]) !== -1) commonLetters++;
                }
                score += Math.min(commonLetters, 5) * 2;

                // Add some randomness to avoid always same choices
                score += Math.random() * 10;

                if (score > 0) {
                    candidates.push({ word: w.word, score: score });
                }
            });

            // Sort by score (highest first) and take top candidates
            candidates.sort(function (a, b) { return b.score - a.score; });

            // Take from different score ranges to have variety
            var result = [];
            var used = {};

            // Take at least one from top 10 (most confusing)
            var top10 = candidates.slice(0, 10);
            if (top10.length > 0) {
                var pick = top10[Math.floor(Math.random() * top10.length)];
                result.push(pick.word);
                used[pick.word] = true;
            }

            // Fill rest with variety
            for (var i = 0; i < candidates.length && result.length < count; i++) {
                if (!used[candidates[i].word]) {
                    result.push(candidates[i].word);
                    used[candidates[i].word] = true;
                }
            }

            // Fallback if not enough candidates
            while (result.length < count) {
                var fallback = allWords[Math.floor(Math.random() * allWords.length)];
                if (fallback && !used[fallback.word] && fallback.word !== correctWord) {
                    result.push(fallback.word);
                    used[fallback.word] = true;
                }
            }

            return result;
        }

        // ========== QUESTION GENERATION ==========
        function generateQuestion(word) {
            // Get available question types based on current level
            var availableTypes = getQuestionTypesForLevel(currentLevelId || 1);

            // Choose a random question type from available ones
            var type = availableTypes[Math.floor(Math.random() * availableTypes.length)];

            // If word has no sentence, avoid fillblank
            if (!word.sentence && type === 'fillblank') {
                availableTypes = availableTypes.filter(function (t) { return t !== 'fillblank'; });
                type = availableTypes[Math.floor(Math.random() * availableTypes.length)];
            }

            var question = {
                type: type,
                word: word,
                correctAnswer: null,
                choices: [],
                prompt: "",
                badge: ""
            };

            // Get 3 confusing wrong answers
            var wrongWords = getConfusingWords(word.word, 3);

            switch (type) {
                case 'wordmatch':
                    // Word recognition: See word + hear it, pick the matching word
                    question.badge = "üëÄ Ë™çË≠òÂñÆÂ≠ó";
                    question.prompt = "ËÅΩÁôºÈü≥ÔºåÊâæÂá∫Áõ∏ÂêåÁöÑÂñÆÂ≠ó";
                    question.correctAnswer = word.word;
                    question.showEnglish = true;
                    question.autoSpeak = true;
                    question.choices = shuffle([
                        { text: word.word, correct: true },
                        { text: wrongWords[0], correct: false },
                        { text: wrongWords[1], correct: false },
                        { text: wrongWords[2], correct: false }
                    ]);
                    break;

                case 'listen':
                    question.badge = "üîä ËÅΩÈü≥Ëæ®Â≠ó";
                    question.prompt = "ËÅΩÁôºÈü≥ÔºåÈÅ∏Ê≠£Á¢∫ÁöÑÂñÆÂ≠ó";
                    question.correctAnswer = word.word;
                    question.choices = shuffle([
                        { text: word.word, correct: true },
                        { text: wrongWords[0], correct: false },
                        { text: wrongWords[1], correct: false },
                        { text: wrongWords[2], correct: false }
                    ]);
                    break;

                case 'translate':
                    question.badge = "üî§ ‰∏≠ÁøªËã±";
                    question.prompt = "„Äå" + word.meaning + "„ÄçÁöÑËã±ÊñáÊòØÔºü";
                    question.correctAnswer = word.word;
                    question.choices = shuffle([
                        { text: word.word, correct: true },
                        { text: wrongWords[0], correct: false },
                        { text: wrongWords[1], correct: false },
                        { text: wrongWords[2], correct: false }
                    ]);
                    break;

                case 'fillblank':
                    question.badge = "üìù Âè•Â≠êÂ°´Á©∫";
                    question.prompt = "ÈÅ∏Âá∫Ê≠£Á¢∫ÁöÑÂñÆÂ≠óÂ°´ÂÖ•Âè•Â≠ê";
                    question.correctAnswer = word.word;
                    // Create sentence with blank
                    var sentence = word.sentence || ("I have a " + word.word + ".");
                    var blankSentence = sentence.replace(new RegExp(word.word, 'gi'), '______');
                    question.blankSentence = blankSentence;
                    question.originalSentence = sentence;
                    question.choices = shuffle([
                        { text: word.word, correct: true },
                        { text: wrongWords[0], correct: false },
                        { text: wrongWords[1], correct: false },
                        { text: wrongWords[2], correct: false }
                    ]);
                    break;

                case 'spell':
                    question.badge = "‚úèÔ∏è ÊãºÂØ´ÊåëÊà∞";
                    question.prompt = "ËÅΩÁôºÈü≥ÔºåÊâìÂá∫Ëã±ÊñáÂñÆÂ≠ó";
                    question.correctAnswer = word.word.toLowerCase();
                    question.showMeaning = true;
                    break;
            }

            return question;
        }

        function renderQuestion(question) {
            currentQuestion = question;
            spellInput = "";
            hintsUsed = 0;

            // Update badge
            document.getElementById("question-type-badge").textContent = question.badge;

            // Hide all optional elements first
            document.getElementById("word-english").classList.add("hidden");
            document.getElementById("word-chinese").classList.add("hidden");
            document.getElementById("play-sound-btn").classList.add("hidden");
            document.getElementById("fillblank-sentence").classList.add("hidden");
            document.getElementById("spell-input-area").classList.add("hidden");
            document.getElementById("choices").classList.remove("hidden");
            document.getElementById("sentence-display").classList.remove("show");

            // Configure based on question type
            switch (question.type) {
                case 'wordmatch':
                    // Show English word and speak it, pick matching word
                    document.getElementById("word-english").textContent = question.word.word;
                    document.getElementById("word-english").classList.remove("hidden");
                    document.getElementById("word-hint").textContent = question.prompt;
                    document.getElementById("play-sound-btn").classList.remove("hidden");
                    // Auto-play the word
                    setTimeout(function () { speakWord(question.word.word); }, 500);
                    break;

                case 'listen':
                    document.getElementById("word-hint").textContent = question.prompt;
                    document.getElementById("play-sound-btn").classList.remove("hidden");
                    // Auto-play the word
                    setTimeout(function () { speakWord(question.word.word); }, 500);
                    break;

                case 'translate':
                    document.getElementById("word-chinese").textContent = question.word.meaning;
                    document.getElementById("word-chinese").classList.remove("hidden");
                    document.getElementById("word-hint").textContent = question.prompt;
                    break;

                case 'fillblank':
                    document.getElementById("word-hint").textContent = question.prompt;
                    document.getElementById("fillblank-sentence").innerHTML = question.blankSentence;
                    document.getElementById("fillblank-sentence").classList.remove("hidden");
                    break;

                case 'spell':
                    document.getElementById("word-chinese").textContent = question.word.meaning;
                    document.getElementById("word-chinese").classList.remove("hidden");
                    document.getElementById("word-hint").textContent = question.prompt;
                    document.getElementById("play-sound-btn").classList.remove("hidden");
                    document.getElementById("choices").classList.add("hidden");
                    document.getElementById("spell-input-area").classList.remove("hidden");
                    updateSpellDisplay();
                    // Auto-play the word
                    setTimeout(function () { speakWord(question.word.word); }, 500);
                    break;
            }

            // Render choices (for non-spell types)
            if (question.type !== 'spell') {
                var container = document.getElementById("choices");
                container.innerHTML = "";
                question.choices.forEach(function (c) {
                    var btn = document.createElement("button");
                    btn.className = "choice-btn";
                    btn.textContent = c.text;
                    btn.addEventListener("click", function () {
                        handleAnswer(btn, c.correct, question.correctAnswer);
                    });
                    container.appendChild(btn);
                });
            }
        }

        function updateSpellDisplay() {
            var display = document.getElementById("spell-display");
            var targetLength = currentQuestion.word.word.length;
            var html = "";

            for (var i = 0; i < targetLength; i++) {
                if (i < spellInput.length) {
                    html += spellInput[i].toUpperCase();
                } else if (i === spellInput.length) {
                    html += '<span class="cursor"> </span>';
                } else {
                    html += "_";
                }
                if (i < targetLength - 1) html += " ";
            }

            display.innerHTML = html;
        }

        function handleKeyPress(key) {
            if (!currentQuestion || currentQuestion.type !== 'spell') return;

            playSound('click');

            if (key === 'BACK') {
                spellInput = spellInput.slice(0, -1);
                updateSpellDisplay();
            } else if (key === 'HINT') {
                // Reveal next letter
                var correctWord = currentQuestion.word.word.toLowerCase();
                if (spellInput.length < correctWord.length && hintsUsed < 3) {
                    spellInput += correctWord[spellInput.length];
                    hintsUsed++;
                    updateSpellDisplay();
                }
            } else if (key === 'ENTER') {
                // Submit answer
                var isCorrect = spellInput.toLowerCase() === currentQuestion.correctAnswer;
                handleAnswer(null, isCorrect, currentQuestion.correctAnswer);
            } else if (key.length === 1 && /[A-Z]/.test(key)) {
                if (spellInput.length < currentQuestion.word.word.length) {
                    spellInput += key.toLowerCase();
                    updateSpellDisplay();
                }
            }
        }

        // ========== API ==========
        async function fetchPlayers() {
            try {
                var res = await fetch("/api/users");
                var users = await res.json();
                var grid = document.getElementById("player-grid");
                grid.innerHTML = "";

                if (users.length === 0) {
                    grid.innerHTML = '<p style="color:#666">ÈÇÑÊ≤íÊúâÂãáËÄÖÔºåÂª∫Á´ã‰∏ÄÂÄãÂêßÔºÅ</p>';
                } else {
                    users.forEach(function (u) {
                        var div = document.createElement("div");
                        div.className = "player-card";
                        var avatar = u.avatar || "üßí";
                        var title = getTitle(u.level);
                        div.innerHTML = '<div class="avatar">' + avatar + '</div>' +
                            '<div class="name">' + u.name + '</div>' +
                            '<div class="level">Lv.' + u.level + ' ¬∑ ' + u.xp + ' XP</div>' +
                            '<div class="player-title" style="color:' + title.color + '">' + title.title + '</div>' +
                            '<button class="btn-delete" title="Âà™Èô§ËßíËâ≤">‚úï</button>';

                        // Click card to select player
                        div.addEventListener("click", function (e) {
                            if (e.target.classList.contains("btn-delete")) return;
                            selectPlayer(u);
                        });

                        // Delete button
                        div.querySelector(".btn-delete").addEventListener("click", function (e) {
                            e.stopPropagation();
                            deletePlayer(u);
                        });

                        grid.appendChild(div);
                    });
                }
            } catch (e) {
                document.getElementById("player-grid").innerHTML = '<p style="color:#f66">ÈÄ£Á∑öÂ§±Êïó</p>';
            }
        }

        async function createUser(name) {
            await fetch("/api/users", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ name: name })
            });
            fetchPlayers();
        }

        function selectPlayer(user) {
            currentUser = user;
            updatePlayerDisplay();
            fetchAllWords();
            switchView("dashboard-view");
        }

        async function deletePlayer(user) {
            var confirmMsg = "Á¢∫ÂÆöË¶ÅÂà™Èô§„Äå" + user.name + "„ÄçÂóéÔºü\n\n‚ö†Ô∏è ÊâÄÊúâÈÅäÊà≤ÈÄ≤Â∫¶Â∞áÊúÉÊ∞∏‰πÖÂà™Èô§ÔºÅ";
            if (!confirm(confirmMsg)) return;

            try {
                var res = await fetch("/api/users/" + user.id, { method: "DELETE" });
                if (res.ok) {
                    fetchPlayers();
                } else {
                    alert("Âà™Èô§Â§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶");
                }
            } catch (e) {
                alert("Âà™Èô§Â§±ÊïóÔºö" + e.message);
            }
        }

        async function fetchLevels() {
            var url = "/api/levels";
            if (currentUser) {
                url += "?user_id=" + currentUser.id;
            }
            var res = await fetch(url);
            var levels = await res.json();
            var grid = document.getElementById("level-grid");
            grid.innerHTML = "";

            levels.forEach(function (l, i) {
                var div = document.createElement("div");
                var statusIcon = l.completed ? "‚úì" : (l.unlocked ? "" : "üîí");
                var statusClass = l.completed ? "completed" : (l.unlocked ? "" : "locked");

                // Calculate mastery display (40% needed to unlock next)
                var mastered = l.mastered || 0;
                var total = l.word_count || 50;
                var masteryPercent = l.mastery_percent || 0;
                var needToUnlock = Math.ceil(total * 0.4); // 40% needed = more achievable!

                div.className = "level-card " + statusClass;
                div.style.position = "relative";
                div.innerHTML = '<div class="num">' + (statusIcon || l.id) + '</div>' +
                    '<div class="level-num">Á¨¨ ' + l.id + ' Èóú</div>' +
                    '<div class="mastery-bar"><div class="mastery-fill" style="width:' + Math.min(100, mastered / needToUnlock * 100) + '%"></div></div>' +
                    '<div class="mastery-text">‚≠ê ' + mastered + '/' + needToUnlock + ' Á≤æÁÜü</div>' +
                    '<button class="btn-browse" data-level="' + l.id + '">üìñ ÁÄèË¶Ω</button>';

                // Click card to start battle
                div.addEventListener("click", function (e) {
                    if (e.target.classList.contains("btn-browse")) return;
                    if (l.unlocked) {
                        startBattle(l);
                    } else {
                        alert("Á≤æÁÜüÂâç‰∏ÄÈóú 40% ÁöÑÂñÆÂ≠óÂç≥ÂèØËß£ÈéñÔºÅ\nÔºàÊØèÂÄãÂñÆÂ≠óÁ≠îÂ∞ç 2 Ê¨° = Á≤æÁÜüÔºâ");
                    }
                });

                // Browse button - always available
                div.querySelector(".btn-browse").addEventListener("click", function (e) {
                    e.stopPropagation();
                    browseWords(l.id);
                });

                grid.appendChild(div);
            });
        }

        async function fetchAllWords() {
            var res = await fetch("/api/words/all");
            allWords = await res.json();
        }

        async function browseWords(levelId) {
            var url = "/api/levels/" + levelId + "/words";
            if (currentUser) {
                url += "?user_id=" + currentUser.id;
            }

            try {
                var res = await fetch(url);
                var data = await res.json();

                document.getElementById("words-title").textContent = "üìö " + data.level_title;
                document.getElementById("words-subtitle").textContent =
                    "Á¨¨ " + levelId + " Èóú ¬∑ " + data.total_words + " ÂÄãÂñÆÂ≠ó";

                var container = document.getElementById("word-list");
                container.innerHTML = "";

                data.words.forEach(function (w, i) {
                    var div = document.createElement("div");
                    div.className = "word-item" + (w.mastered ? " mastered" : "");

                    var statusText = w.mastered ? "‚úì Â∑≤Á≤æÁÜü" :
                        (w.correct_count > 0 ? "Â≠∏Áøí‰∏≠ " + w.correct_count + "/2" : "Êú™Â≠∏Áøí");
                    var statusClass = w.mastered ? "mastered" : "";

                    div.innerHTML =
                        '<div class="word-header">' +
                        '<span class="english">' + (i + 1) + '. ' + w.word +
                        '<button class="btn-speak" onclick="speakWord(\'' + w.word + '\')" title="Êí≠ÊîæÁôºÈü≥">üîä</button>' +
                        '</span>' +
                        '<span class="status ' + statusClass + '">' + statusText + '</span>' +
                        '</div>' +
                        '<div class="chinese">' + w.meaning + '</div>' +
                        (w.sentence ? '<div class="sentence">"' + w.sentence + '"</div>' : '');

                    container.appendChild(div);
                });

                document.getElementById("modal-words").classList.remove("hidden");
            } catch (e) {
                alert("ÁÑ°Ê≥ïËºâÂÖ•ÂñÆÂ≠óÂàóË°®Ôºö" + e.message);
            }
        }

        async function fetchWeakWords() {
            if (!currentUser) return [];
            var res = await fetch("/api/words/weak?user_id=" + currentUser.id + "&limit=10");
            return await res.json();
        }

        async function recordWordAnswer(wordId, correct) {
            if (!currentUser) return;
            await fetch("/api/words/answer?user_id=" + currentUser.id + "&word_id=" + wordId + "&correct=" + correct, {
                method: "POST"
            });
        }

        // ========== WORLD & STAGE LOGIC ==========
        async function fetchWorlds() {
            try {
                var res = await fetch("/api/worlds");
                var worlds = await res.json();
                renderWorldMap(worlds);
            } catch (e) {
                console.error("Failed to fetch worlds:", e);
            }
        }

        function renderWorldMap(worlds) {
            var container = document.getElementById("world-map-container");
            container.innerHTML = "";

            // Fallback images for worlds
            var worldImages = [
                "https://images.unsplash.com/photo-1523050854058-8df90110c9f1?q=80&w=600", // Academy
                "https://images.unsplash.com/photo-1448375240586-dfd8d395ea6c?q=80&w=600", // Forest
                "https://images.unsplash.com/photo-1627768846176-59178ad80f48?q=80&w=600", // Castle
                "https://images.unsplash.com/photo-1515630278258-407f66498911?q=80&w=600", // SciFi
                "https://images.unsplash.com/photo-1599707367072-cd6ad66acc40?q=80&w=600"  // Ruins
            ];

            worlds.forEach(function (w, index) {
                var card = document.createElement("div");
                card.className = "world-card";
                card.style.backgroundImage = "url('" + (worldImages[index] || worldImages[0]) + "')";
                card.onclick = function () { loadWorldStages(w); };

                // Lock logic: For now unlock all, or check user Lexile
                // if (userLexile < w.min_lexile) card.classList.add("locked");

                var html = '<div class="world-info">' +
                    '<div class="world-title">' + w.name + '</div>' +
                    '<div class="world-badge" style="background:' + w.theme_color + '">' + w.min_lexile + 'L - ' + w.max_lexile + 'L</div>' +
                    '<div class="world-desc">' + w.description + '</div>' +
                    '<button class="btn btn-primary btn-sm">ÈÄ≤ÂÖ•‰∏ñÁïå ‚Üí</button>' +
                    '</div>';

                card.innerHTML = html;
                container.appendChild(card);
            });
        }

        async function loadWorldStages(world) {
            switchView("stage-select-view");
            document.getElementById("selected-world-title").textContent = world.name;
            document.getElementById("selected-world-lexile").textContent = world.min_lexile + "L - " + world.max_lexile + "L";
            document.getElementById("selected-world-lexile").style.background = world.theme_color;

            // Fetch passages filtered by world
            try {
                var res = await fetch("/api/reading/passages?world_id=" + world.id + "&user_id=" + (currentUser ? currentUser.id : ""));
                var data = await res.json();
                renderStages(data.passages);
            } catch (e) {
                console.error("Failed to fetch stages:", e);
            }
        }

        function renderStages(passages) {
            var container = document.getElementById("stage-list");
            container.innerHTML = "";

            if (passages.length === 0) {
                container.innerHTML = "<div style='grid-column:1/-1;text-align:center;padding:40px;'>Êö´ÁÑ°ÈóúÂç°</div>";
                return;
            }

            var lastChapter = -1;

            passages.forEach(function (p) {
                // Group by chapter header?
                if (p.chapter !== lastChapter) {
                    // Insert chapter divider if we wanted
                    lastChapter = p.chapter;
                }

                var node = document.createElement("div");
                node.className = "stage-node" + (p.completed ? " completed" : "") + (p.boss_name ? " boss-node" : "");
                node.onclick = function () { startReading(p.id); };

                var imgUrl = p.image_url || "https://placehold.co/100x100?text=?";

                var html = '';
                if (p.boss_name) {
                    html += '<div class="boss-badge">BOSS</div>';
                }

                html += '<img src="' + imgUrl + '" class="stage-img-thumb" alt="Stage">';
                html += '<div style="font-weight:bold;margin-bottom:4px;">' + (p.chapter) + '-' + (p.episode) + '</div>';
                html += '<div style="font-size:12px;line-height:1.2;height:2.4em;overflow:hidden;">' + p.title + '</div>';

                if (p.completed) {
                    html += '<div style="color:#2ecc71;font-size:12px;margin-top:4px;">‚≠ê ÂÆåÊàê (' + p.score + '%)</div>';
                } else {
                    html += '<div style="color:#95a5a6;font-size:12px;margin-top:4px;">Êú™ÂÆåÊàê</div>';
                }

                node.innerHTML = html;
                container.appendChild(node);
            });
        }

        // ========== READING MODE ==========
        async function fetchPassages() {
            // This function is now largely replaced by fetchWorlds and loadWorldStages
            // but kept for compatibility if needed elsewhere.
            // For now, it will just update the user lexile display.
            if (currentUser) {
                try {
                    var res = await fetch("/api/reading/user-lexile?user_id=" + currentUser.id);
                    var data = await res.json();
                    userLexile = data.user_lexile || 350;
                    // document.getElementById("user-lexile").textContent = "Lexile: " + userLexile + "L";
                } catch (e) {
                    console.error("Failed to fetch user lexile:", e);
                }
            }
        }

        async function startReading(passageId) {
            try {
                var res = await fetch("/api/reading/passages/" + passageId);
                currentPassage = await res.json();
                readingQuestions = currentPassage.questions;
                currentReadingQuestion = 0;
                readingAnswers = {};

                // Update UI
                document.getElementById("passage-title").textContent = currentPassage.title;

                var imgEl = document.getElementById("passage-image");
                if (currentPassage.image_url) {
                    imgEl.src = currentPassage.image_url;
                    imgEl.style.display = "inline-block";
                } else {
                    imgEl.style.display = "none";
                }

                // Handle Boss
                var bossOverlay = document.getElementById("boss-overlay");
                if (currentPassage.boss_name) {
                    bossOverlay.classList.remove("hidden");
                    document.getElementById("boss-name-battle").textContent = currentPassage.boss_name;
                    document.getElementById("boss-avatar-battle").src = currentPassage.boss_image || currentPassage.image_url;
                    document.getElementById("boss-hp-text").textContent = currentPassage.boss_hp + "/" + currentPassage.boss_hp;
                    document.getElementById("boss-hp-fill").style.width = "100%";
                    // Store boss stats for battle logic
                    currentPassage.currentBossHp = currentPassage.boss_hp;
                } else {
                    bossOverlay.classList.add("hidden");
                }

                document.getElementById("passage-content").textContent = currentPassage.content;
                document.getElementById("reading-lexile").textContent = currentPassage.lexile_level + "L";
                document.getElementById("reading-progress").textContent = "Èñ±ËÆÄ‰∏≠";

                // Show vocabulary
                var vocabList = document.getElementById("vocab-list");
                vocabList.innerHTML = "";
                if (currentPassage.vocabulary && currentPassage.vocabulary.length > 0) {
                    currentPassage.vocabulary.forEach(function (v) {
                        var span = document.createElement("span");
                        span.className = "vocab-item";
                        span.innerHTML = '<span class="word">' + v.word + '</span><span class="meaning">' + v.meaning + '</span>';
                        span.addEventListener("click", function () {
                            speakWord(v.word);
                        });
                        vocabList.appendChild(span);
                    });
                }

                // Reset sections
                document.getElementById("passage-section").classList.remove("hidden");
                document.getElementById("questions-section").classList.add("hidden");
                document.getElementById("reading-result-section").classList.add("hidden");
                document.getElementById("vocab-panel").classList.add("hidden");

                switchView("reading-view");
            } catch (e) {
                alert("ÁÑ°Ê≥ïËºâÂÖ•ÊñáÁ´†Ôºö" + e.message);
            }
        }

        function startReadingQuestions() {
            document.getElementById("passage-section").classList.add("hidden");
            document.getElementById("questions-section").classList.remove("hidden");
            currentReadingQuestion = 0;
            renderReadingQuestion();
        }

        function renderReadingQuestion() {
            if (currentReadingQuestion >= readingQuestions.length) {
                submitReadingAnswers();
                return;
            }

            var q = readingQuestions[currentReadingQuestion];
            document.getElementById("reading-progress").textContent = "È°åÁõÆ " + (currentReadingQuestion + 1) + "/" + readingQuestions.length;

            var container = document.getElementById("question-container");
            var optionsHtml = "";
            var optionKeys = Object.keys(q.options).filter(function (k) { return q.options[k]; });

            optionKeys.forEach(function (key) {
                var selected = readingAnswers[q.id] === key;
                optionsHtml += '<button class="option-btn' + (selected ? ' selected' : '') + '" data-option="' + key + '">' +
                    '<span class="option-label">' + key + '</span>' + q.options[key] +
                    '</button>';
            });

            container.innerHTML =
                '<div class="question-panel">' +
                '<div class="question-number">' + getQuestionTypeLabel(q.type) + '</div>' +
                '<div class="question-text">' + q.question + '</div>' +
                '<div class="question-options">' + optionsHtml + '</div>' +
                '</div>';

            // Add click handlers
            container.querySelectorAll(".option-btn").forEach(function (btn) {
                btn.addEventListener("click", function () {
                    readingAnswers[q.id] = btn.getAttribute("data-option");
                    container.querySelectorAll(".option-btn").forEach(function (b) {
                        b.classList.remove("selected");
                    });
                    btn.classList.add("selected");
                });
            });

            // Update navigation buttons
            document.getElementById("btn-prev-q").disabled = currentReadingQuestion === 0;
            var nextBtn = document.getElementById("btn-next-q");
            if (currentReadingQuestion === readingQuestions.length - 1) {
                nextBtn.textContent = "Êèê‰∫§Á≠îÊ°à ‚úì";
            } else {
                nextBtn.textContent = "‰∏ã‰∏ÄÈ°å ‚Üí";
            }
        }

        function getQuestionTypeLabel(type) {
            switch (type) {
                case "comprehension": return "üìñ Èñ±ËÆÄÁêÜËß£";
                case "vocabulary": return "üìù Ë©ûÂΩôÁêÜËß£";
                case "inference": return "ü§î Êé®ÁêÜÂà§Êñ∑";
                case "main_idea": return "üí° ‰∏ªÊó®Â§ßÊÑè";
                default: return "‚ùì ÂïèÈ°å";
            }
        }

        function prevReadingQuestion() {
            if (currentReadingQuestion > 0) {
                currentReadingQuestion--;
                renderReadingQuestion();
            }
        }

        function nextReadingQuestion() {
            if (currentReadingQuestion < readingQuestions.length - 1) {
                currentReadingQuestion++;
                renderReadingQuestion();
            } else {
                submitReadingAnswers();
            }
        }

        async function submitReadingAnswers() {
            if (!currentUser || !currentPassage) return;

            try {
                var res = await fetch("/api/reading/passages/" + currentPassage.id + "/submit?user_id=" + currentUser.id, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(readingAnswers)
                });
                var result = await res.json();

                // Show results
                document.getElementById("questions-section").classList.add("hidden");
                document.getElementById("reading-result-section").classList.remove("hidden");

                document.getElementById("reading-score").textContent = result.score + "%";
                document.getElementById("reading-detail").textContent = "Á≠îÂ∞ç " + result.correct + " / " + result.total + " È°å";
                document.getElementById("reading-xp").textContent = "+" + result.xp_earned + " XP";

                // Lexile change message
                var lexileMsg = "";
                if (result.new_lexile > userLexile) {
                    lexileMsg = "üìà Lexile ÊèêÂçáÔºÅ " + userLexile + "L ‚Üí " + result.new_lexile + "L";
                } else if (result.new_lexile < userLexile) {
                    lexileMsg = "üìâ Lexile: " + result.new_lexile + "L";
                } else {
                    lexileMsg = "üìä Lexile: " + result.new_lexile + "L";
                }
                document.getElementById("reading-lexile-change").textContent = lexileMsg;
                userLexile = result.new_lexile;

                // Update user XP
                if (currentUser) {
                    currentUser.xp += result.xp_earned;
                    updatePlayerDisplay();
                }

                // Store results for review
                window.readingResults = result.results;

            } catch (e) {
                alert("Êèê‰∫§Â§±ÊïóÔºö" + e.message);
            }
        }

        function showAnswerReview() {
            if (!window.readingResults) return;

            var container = document.getElementById("question-container");
            var html = "";

            readingQuestions.forEach(function (q, i) {
                var result = window.readingResults.find(function (r) { return r.question_id === q.id; });
                var isCorrect = result && result.correct;

                html += '<div class="question-panel" style="margin-bottom:16px;">' +
                    '<div class="question-number">' + getQuestionTypeLabel(q.type) + '</div>' +
                    '<div class="question-text">' + q.question + '</div>' +
                    '<div class="question-options">';

                Object.keys(q.options).filter(function (k) { return q.options[k]; }).forEach(function (key) {
                    var classes = "option-btn";
                    if (key === result.correct_answer) classes += " correct";
                    else if (key === result.user_answer && !result.correct) classes += " wrong";

                    html += '<button class="' + classes + '" disabled>' +
                        '<span class="option-label">' + key + '</span>' + q.options[key] +
                        '</button>';
                });

                html += '</div>';

                if (q.explanation) {
                    html += '<div class="explanation-box">üí° ' + q.explanation + '</div>';
                }

                html += '</div>';
            });

            container.innerHTML = html;
            document.getElementById("reading-result-section").classList.add("hidden");
            document.getElementById("questions-section").classList.remove("hidden");
            document.getElementById("btn-prev-q").classList.add("hidden");
            document.getElementById("btn-next-q").textContent = "ËøîÂõûÁµêÊûú";
            document.getElementById("btn-next-q").onclick = function () {
                document.getElementById("questions-section").classList.add("hidden");
                document.getElementById("reading-result-section").classList.remove("hidden");
                document.getElementById("btn-prev-q").classList.remove("hidden");
                document.getElementById("btn-next-q").onclick = nextReadingQuestion;
            };
        }

        function finishReading() {
            switchView("dashboard-view");
            fetchPassages(); // Re-fetch passages to update completion status
        }

        // ========== GAME LOGIC ==========
        function selectPlayer(u) {
            currentUser = u;
            updatePlayerDisplay();
            switchView("dashboard-view");
            fetchLevels(); // Fetch levels for vocab battle
            fetchPassages(); // Fetch passages for reading mode (to update user lexile)
            fetchAllWords();
            checkWeakWords();
        }

        function updatePlayerDisplay() {
            if (!currentUser) return;

            var title = getTitle(currentUser.level);
            var xpBonus = getXPBonus(currentUser.level);
            var timeBonus = getTimeBonus(currentUser.level);

            document.getElementById("info-name").textContent = currentUser.name;
            document.getElementById("info-stats").textContent = "Lv." + currentUser.level + " ¬∑ " + currentUser.xp + " XP";
            document.getElementById("info-title").textContent = title.title;
            document.getElementById("info-title").style.color = title.color;

            // Show avatar (use saved or default)
            var avatar = currentUser.avatar || "üßí";
            document.getElementById("info-avatar").textContent = avatar;

            // Show bonuses if any
            var bonusText = "";
            if (timeBonus > 0) bonusText += " ‚è±Ô∏è+" + timeBonus + "Áßí";
            if (xpBonus > 0) bonusText += " ‚ú®+" + Math.round(xpBonus * 100) + "%XP";
            if (bonusText) {
                document.getElementById("info-stats").textContent += bonusText;
            }
        }

        function showAvatarSelector() {
            var container = document.getElementById("avatar-selector");
            container.innerHTML = "";

            var unlockedAvatars = getUnlockedAvatars(currentUser.level);
            var unlockedEmojis = unlockedAvatars.map(function (a) { return a.emoji; });

            AVATARS.forEach(function (avatar) {
                var div = document.createElement("div");
                var isUnlocked = currentUser.level >= avatar.unlockLevel;
                var isSelected = (currentUser.avatar || "üßí") === avatar.emoji;

                div.className = "avatar-option" + (isSelected ? " selected" : "") + (isUnlocked ? "" : " locked");
                div.innerHTML = avatar.emoji + (isUnlocked ? "" : '<span class="lock-badge">üîí</span>');
                div.title = avatar.name + (isUnlocked ? "" : " (Lv." + avatar.unlockLevel + " Ëß£Èéñ)");

                if (isUnlocked) {
                    div.addEventListener("click", function () {
                        currentUser.avatar = avatar.emoji;
                        // Update UI
                        document.querySelectorAll(".avatar-option").forEach(function (el) { el.classList.remove("selected"); });
                        div.classList.add("selected");
                        document.getElementById("info-avatar").textContent = avatar.emoji;
                        // Save to server
                        saveUserAvatar(avatar.emoji);
                    });
                }

                container.appendChild(div);
            });

            document.getElementById("modal-avatar").classList.remove("hidden");
        }

        async function saveUserAvatar(emoji) {
            // Save avatar preference (we'll add this API endpoint)
            if (!currentUser) return;
            try {
                await fetch("/api/users/" + currentUser.id + "/avatar?avatar=" + encodeURIComponent(emoji), {
                    method: "POST"
                });
            } catch (e) {
                console.log("Could not save avatar");
            }
        }

        async function checkWeakWords() {
            var weakWords = await fetchWeakWords();
            var btn = document.getElementById("btn-review");
            if (weakWords.length >= 3) {
                btn.classList.remove("hidden");
                btn.textContent = "üìö Ë§áÁøíÂº±ÈªûÂñÆÂ≠ó (" + weakWords.length + "ÂÄã)";
            } else {
                btn.classList.add("hidden");
            }
        }

        async function startReviewMode() {
            var weakWords = await fetchWeakWords();
            if (weakWords.length < 3) {
                alert("‰Ω†ÁöÑÂº±ÈªûÂñÆÂ≠ó‰∏çÂ§†Â§öÔºåÁπºÁ∫åÊåëÊà∞Êñ∞ÈóúÂç°ÂêßÔºÅ");
                return;
            }

            isReviewMode = true;
            gameWords = weakWords.slice(0, 5);
            // Use level 15 difficulty for review (moderate - english + listen types)
            currentLevelId = 15;

            // Reset game state
            currentRound = 0;
            combo = 0;
            maxCombo = 0;
            correctCount = 0;
            playerHP = 100;
            totalSpeedBonus = 0;

            // Use a special monster for review
            var monster = { emoji: "üìñ", name: "Ë§áÁøíÊÄ™", hp: 100, color: "#3498db" };
            monsterHP = monster.hp;
            monsterMaxHP = monster.hp;

            document.getElementById("monster-emoji").textContent = monster.emoji;
            document.getElementById("monster-name").textContent = monster.name;
            document.getElementById("monster-name").style.color = monster.color;
            document.getElementById("monster-level").textContent = "Ë§áÁøíÊ®°Âºè";
            document.getElementById("monster-hp-fill").style.width = "100%";

            // Apply monster glow color
            var stage = document.getElementById("monster-stage");
            stage.style.setProperty('--monster-color', monster.color);
            document.getElementById("player-hp-fill").style.width = "100%";
            document.getElementById("player-hp-text").textContent = "100/100";

            switchView("battle-view");
            nextRound();
        }

        async function startBattle(level) {
            // Pass user_id for smart word selection (prioritizes weak/unseen words)
            var url = "/api/game/start/" + level.id + "?count=5";
            if (currentUser) {
                url += "&user_id=" + currentUser.id;
            }
            var res = await fetch(url);
            gameWords = await res.json();

            if (gameWords.length === 0) {
                alert("ÈÄôÂÄãÈóúÂç°Ê≤íÊúâÂñÆÂ≠óÔºÅ");
                return;
            }

            isReviewMode = false;

            // Reset game state
            currentLevelId = level.id;
            currentRound = 0;
            combo = 0;
            maxCombo = 0;
            correctCount = 0;
            playerHP = 100;
            totalSpeedBonus = 0;

            // Pick a monster based on level
            var monsterIndex = Math.min(Math.floor(level.id / 5), MONSTERS.length - 1);
            var monster = MONSTERS[monsterIndex];
            monsterHP = monster.hp;
            monsterMaxHP = monster.hp;

            document.getElementById("monster-emoji").textContent = monster.emoji;
            document.getElementById("monster-name").textContent = monster.name;
            document.getElementById("monster-name").style.color = monster.color;
            document.getElementById("monster-level").textContent = "Lv." + level.id;
            document.getElementById("monster-hp-fill").style.width = "100%";

            // Apply monster glow color
            var stage = document.getElementById("monster-stage");
            stage.style.setProperty('--monster-color', monster.color);
            document.getElementById("player-hp-fill").style.width = "100%";
            document.getElementById("player-hp-text").textContent = "100/100";

            switchView("battle-view");
            nextRound();
        }

        function nextRound() {
            // End battle if: all questions done, player dead, OR monster dead
            if (currentRound >= gameWords.length || playerHP <= 0 || monsterHP <= 0) {
                endBattle();
                return;
            }

            var word = gameWords[currentRound];
            document.getElementById("round-display").textContent = (currentRound + 1) + "/" + gameWords.length;

            // Update combo display
            var comboEl = document.getElementById("combo-display");
            if (combo >= 2) {
                comboEl.textContent = "üî• COMBO x" + combo;
                comboEl.classList.add("active");
            } else {
                comboEl.classList.remove("active");
            }

            // Generate and render question
            var question = generateQuestion(word);
            renderQuestion(question);

            // Track question start time for speed bonus
            questionStartTime = Date.now();

            // Start timer
            startTimer();
        }

        function startTimer() {
            // Adjust time based on level difficulty
            var levelId = currentLevelId || 1;
            var baseTime = 15;

            if (levelId <= 10) {
                baseTime = 20; // More time for beginners
            } else if (levelId <= 20) {
                baseTime = 18;
            } else if (levelId <= 30) {
                baseTime = 15;
            } else {
                baseTime = 12; // Harder levels = less time
            }

            // Spell questions always get extra time
            if (currentQuestion && currentQuestion.type === 'spell') {
                baseTime = Math.max(baseTime, 20);
            }

            // Add time bonus from player level (every 5 levels = +1 second)
            var playerTimeBonus = currentUser ? getTimeBonus(currentUser.level) : 0;
            baseTime += playerTimeBonus;

            timeLeft = baseTime;
            var maxTime = baseTime;
            document.getElementById("timer-fill").style.width = "100%";

            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(function () {
                timeLeft -= 0.1;
                document.getElementById("timer-fill").style.width = (timeLeft / maxTime * 100) + "%";

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    handleTimeout();
                }
            }, 100);
        }

        function handleTimeout() {
            // Time's up = wrong answer
            handleAnswer(null, false, currentQuestion ? currentQuestion.correctAnswer : "");
        }

        function handleAnswer(btn, correct, correctAnswer) {
            clearInterval(timerInterval);

            // Disable all buttons
            var buttons = document.querySelectorAll(".choice-btn");
            buttons.forEach(function (b) { b.disabled = true; });

            // Disable keyboard
            document.querySelectorAll(".key-btn").forEach(function (k) { k.disabled = true; });

            // Record answer for mastery tracking
            var word = gameWords[currentRound];
            recordWordAnswer(word.id, correct);

            // Show correct/wrong for choice-based questions
            if (btn) {
                btn.classList.add(correct ? "correct" : "wrong");
            }

            // For spell questions, show the correct answer
            if (currentQuestion && currentQuestion.type === 'spell') {
                var display = document.getElementById("spell-display");
                if (correct) {
                    display.style.color = "#2ed573";
                } else {
                    display.innerHTML = '<span style="color:#ff4757;text-decoration:line-through">' + spellInput.toUpperCase() + '</span> ‚Üí <span style="color:#2ed573">' + correctAnswer.toUpperCase() + '</span>';
                }
            }

            // Highlight correct answer if wrong (for choice questions)
            if (!correct && currentQuestion && currentQuestion.type !== 'spell') {
                buttons.forEach(function (b) {
                    if (b.textContent === correctAnswer) b.classList.add("correct");
                });
            }

            // Show example sentence
            if (word.sentence) {
                var sentenceEl = document.getElementById("sentence-display");
                sentenceEl.innerHTML = "üìñ " + word.sentence;
                sentenceEl.classList.add("show");
            }

            // Play sound effect
            playSound(correct ? 'correct' : 'wrong');

            var monsterEl = document.getElementById("monster-emoji");

            if (correct) {
                // Correct answer - attack monster!
                combo++;
                if (combo > maxCombo) maxCombo = combo;
                correctCount++;

                // Calculate speed bonus (answer in <3 seconds = +5 XP, <5 seconds = +3 XP)
                var answerTime = (Date.now() - questionStartTime) / 1000;
                if (answerTime < 3) {
                    totalSpeedBonus += 5;
                } else if (answerTime < 5) {
                    totalSpeedBonus += 3;
                }

                // Play attack sound
                setTimeout(function () { playSound('attack'); }, 200);

                // Calculate damage (base + combo bonus + time bonus)
                var baseDamage = 20;
                var comboBonus = Math.min(combo - 1, 5) * 5;
                var timeBonus = Math.floor(timeLeft * 2);
                // Penalty for using hints in spell mode
                var hintPenalty = hintsUsed * 5;
                var totalDamage = Math.max(10, baseDamage + comboBonus + timeBonus - hintPenalty);

                monsterHP -= totalDamage;
                if (monsterHP < 0) monsterHP = 0;

                // Visual effects
                flashScreen();
                monsterEl.classList.add("shake", "hurt");
                showDamage(totalDamage, combo >= 3 ? "critical" : "");

                document.getElementById("monster-hp-fill").style.width = (monsterHP / monsterMaxHP * 100) + "%";

                setTimeout(function () {
                    monsterEl.classList.remove("shake", "hurt");
                }, 300);

                // Speak the word after correct answer
                setTimeout(function () { speakWord(word.word); }, 500);

            } else {
                // Wrong answer - monster attacks player!
                combo = 0;
                var damage = 20;
                playerHP -= damage;
                if (playerHP < 0) playerHP = 0;

                showDamage(damage, "miss");
                document.getElementById("player-hp-fill").style.width = playerHP + "%";
                document.getElementById("player-hp-text").textContent = playerHP + "/100";
            }

            // Next round after delay (longer to read sentence)
            setTimeout(function () {
                // Re-enable keyboard for next round
                document.querySelectorAll(".key-btn").forEach(function (k) { k.disabled = false; });
                currentRound++;
                nextRound();
            }, 2500);
        }

        async function endBattle() {
            // Win if: player alive AND (monster dead OR all questions answered)
            var won = playerHP > 0 && (monsterHP <= 0 || currentRound >= gameWords.length);
            var questionsAnswered = Math.min(currentRound, gameWords.length);
            var accuracy = questionsAnswered > 0 ? Math.round(correctCount / questionsAnswered * 100) : 0;

            // NEW XP SYSTEM: More balanced, harder to level up
            // Base: 10 XP per correct (was 20)
            // Combo bonus: +2 XP per combo level
            // Perfect bonus: +50% if all correct
            // Speed bonus: tracked in totalSpeedBonus
            var baseXP = correctCount * 10;
            var comboXP = maxCombo * 2;
            var perfectBonus = (correctCount === questionsAnswered && questionsAnswered > 0) ? Math.floor(baseXP * 0.5) : 0;
            var speedXP = totalSpeedBonus || 0;

            var subtotalXP = baseXP + comboXP + perfectBonus + speedXP;

            // Apply player level bonus (smaller now)
            var xpBonusPercent = currentUser ? getXPBonus(currentUser.level) : 0;
            var levelBonusXP = Math.floor(subtotalXP * xpBonusPercent);
            var totalXP = subtotalXP + levelBonusXP;

            // Play appropriate sound
            playSound(won ? 'levelup' : 'wrong');

            // Different messages based on outcome
            var monsterKilled = monsterHP <= 0;
            if (won && monsterKilled) {
                document.getElementById("result-emoji").textContent = "‚öîÔ∏è";
                document.getElementById("result-title").textContent = "ÊÄ™Áâ©ÊìäÊïóÔºÅ";
            } else if (won) {
                document.getElementById("result-emoji").textContent = "üéâ";
                document.getElementById("result-title").textContent = "ÂãùÂà©ÔºÅ";
            } else {
                document.getElementById("result-emoji").textContent = "üíÄ";
                document.getElementById("result-title").textContent = "Êà∞Êïó...";
            }
            document.getElementById("result-accuracy").textContent = "Ê≠£Á¢∫Áéá: " + accuracy + "% (" + correctCount + "/" + questionsAnswered + ")";
            document.getElementById("result-combo").textContent = "ÊúÄÈ´òÈÄ£Êìä: " + maxCombo;

            // Build detailed XP breakdown
            var xpLines = [];
            xpLines.push("Âü∫Á§é: +" + baseXP);
            if (comboXP > 0) xpLines.push("ÈÄ£Êìä: +" + comboXP);
            if (perfectBonus > 0) xpLines.push("üéØÂÖ®Â∞ç: +" + perfectBonus);
            if (speedXP > 0) xpLines.push("‚ö°Âø´ÈÄü: +" + speedXP);
            if (levelBonusXP > 0) xpLines.push("Á≠âÁ¥öÂä†Êàê: +" + levelBonusXP);
            var xpText = xpLines.join(" | ") + "\nÁ∏ΩË®à: +" + totalXP + " XP";
            document.getElementById("result-xp").textContent = xpText;

            // Track old level for level-up detection
            var oldLevel = currentUser ? currentUser.level : 1;

            // Update XP and level completion
            var levelCompleted = false;
            if (currentUser && !isReviewMode) {
                var url = "/api/users/" + currentUser.id + "/progress?xp_gained=" + totalXP +
                    "&level_id=" + currentLevelId + "&score=" + accuracy;
                var res = await fetch(url, { method: "POST" });
                var data = await res.json();
                currentUser.xp = data.xp;
                currentUser.level = data.level;
                levelCompleted = data.level_completed;
                updatePlayerDisplay();
            } else if (currentUser && isReviewMode) {
                // Give some XP for review mode too
                var reviewXP = Math.floor(totalXP * 0.5);
                var url = "/api/users/" + currentUser.id + "/progress?xp_gained=" + reviewXP;
                var res = await fetch(url, { method: "POST" });
                var data = await res.json();
                currentUser.xp = data.xp;
                currentUser.level = data.level;
                updatePlayerDisplay();
                document.getElementById("result-xp").textContent = "+" + reviewXP + " XP (Ë§áÁøíÁçéÂãµ)";
            }

            // Show unlock message if level completed
            if (levelCompleted) {
                document.getElementById("result-title").textContent = "üéä ÈóúÂç°ÂÆåÊàêÔºÅ";
                document.getElementById("result-xp").textContent = xpText + "\nüîì Ëß£Èéñ‰∏ã‰∏ÄÈóúÔºÅ";
            }

            // Check for player level up
            if (currentUser && currentUser.level > oldLevel) {
                showLevelUpCelebration(oldLevel, currentUser.level);
            } else {
                document.getElementById("result-overlay").classList.remove("hidden");
            }
        }

        function showLevelUpCelebration(oldLevel, newLevel) {
            var title = getTitle(newLevel);
            var oldTitle = getTitle(oldLevel);

            document.getElementById("levelup-number").textContent = "Lv." + newLevel;
            document.getElementById("levelup-title").textContent = title.title;
            document.getElementById("levelup-title").style.color = title.color;

            // Build rewards list
            var rewardsHtml = "";

            // Check for new title
            if (title.title !== oldTitle.title) {
                rewardsHtml += '<div class="levelup-reward-item reward-new">üè∑Ô∏è Êñ∞Á®±Ëôü: ' + title.title + '</div>';
            }

            // Check for new avatar unlock
            var newAvatars = AVATARS.filter(function (a) { return a.unlockLevel === newLevel; });
            newAvatars.forEach(function (a) {
                rewardsHtml += '<div class="levelup-reward-item reward-new">üé≠ Ëß£ÈéñÈ†≠ÂÉè: ' + a.emoji + ' ' + a.name + '</div>';
            });

            // Check for time bonus milestone
            if (newLevel % 5 === 0) {
                rewardsHtml += '<div class="levelup-reward-item reward-new">‚è±Ô∏è Á≠îÈ°åÊôÇÈñì +1 ÁßíÔºÅ</div>';
            }

            // Check for XP bonus milestone
            if (newLevel % 10 === 0) {
                rewardsHtml += '<div class="levelup-reward-item reward-new">‚ú® XP Áç≤Âæó +10%ÔºÅ</div>';
            }

            if (!rewardsHtml) {
                rewardsHtml = '<div class="levelup-reward-item">ÁπºÁ∫åÂä™ÂäõÂçáÁ¥öÁç≤ÂæóÊõ¥Â§öÁçéÂãµÔºÅ</div>';
            }

            document.getElementById("levelup-rewards").innerHTML = rewardsHtml;
            document.getElementById("levelup-overlay").classList.remove("hidden");

            // Play level up sound
            playSound('levelup');
        }

        // ========== EVENT LISTENERS ==========
        document.addEventListener("DOMContentLoaded", function () {
            // Initialize audio on first user interaction
            document.body.addEventListener("click", function () {
                initAudio();
            }, { once: true });

            // Sound toggle
            document.getElementById("btn-sound").addEventListener("click", function (e) {
                e.stopPropagation();
                initAudio();
                toggleSound();
            });

            // Login
            document.getElementById("btn-new-player").addEventListener("click", function () {
                document.getElementById("modal-new-player").classList.remove("hidden");
                document.getElementById("input-name").focus();
            });

            document.getElementById("btn-cancel").addEventListener("click", function () {
                document.getElementById("modal-new-player").classList.add("hidden");
            });

            document.getElementById("btn-create").addEventListener("click", function () {
                var name = document.getElementById("input-name").value.trim();
                if (!name) return alert("Ë´ãËº∏ÂÖ•ÂêçÂ≠óÔºÅ");
                createUser(name);
                document.getElementById("modal-new-player").classList.add("hidden");
                document.getElementById("input-name").value = "";
            });

            // Dashboard
            document.getElementById("btn-logout").addEventListener("click", function () {
                currentUser = null;
                switchView("login-view");
            });

            // Review mode
            document.getElementById("btn-review").addEventListener("click", function () {
                startReviewMode();
            });

            // Battle
            document.getElementById("btn-flee").addEventListener("click", function () {
                if (confirm("Á¢∫ÂÆöË¶ÅÈÄÉË∑ëÂóéÔºü")) {
                    clearInterval(timerInterval);
                    switchView("dashboard-view");
                }
            });

            // Play sound button
            document.getElementById("play-sound-btn").addEventListener("click", function () {
                if (currentQuestion) {
                    speakWord(currentQuestion.word.word);
                }
            });

            // Virtual keyboard
            document.querySelectorAll(".key-btn").forEach(function (btn) {
                btn.addEventListener("click", function () {
                    handleKeyPress(btn.getAttribute("data-key"));
                });
            });

            // Physical keyboard support for spell mode
            document.addEventListener("keydown", function (e) {
                if (currentQuestion && currentQuestion.type === 'spell' && !e.repeat) {
                    var key = e.key.toUpperCase();
                    if (key === 'BACKSPACE') {
                        handleKeyPress('BACK');
                        e.preventDefault();
                    } else if (key === 'ENTER') {
                        handleKeyPress('ENTER');
                        e.preventDefault();
                    } else if (/^[A-Z]$/.test(key)) {
                        handleKeyPress(key);
                        e.preventDefault();
                    }
                }
            });

            // Result
            document.getElementById("btn-continue").addEventListener("click", function () {
                document.getElementById("result-overlay").classList.add("hidden");
                switchView("dashboard-view");
                fetchLevels();
                checkWeakWords();
            });

            // Level up celebration
            document.getElementById("btn-levelup-close").addEventListener("click", function () {
                document.getElementById("levelup-overlay").classList.add("hidden");
                document.getElementById("result-overlay").classList.remove("hidden");
            });

            // Word browser
            document.getElementById("btn-words-close").addEventListener("click", function () {
                document.getElementById("modal-words").classList.add("hidden");
            });

            // Avatar selector
            document.getElementById("player-info-box").addEventListener("click", function () {
                if (currentUser) {
                    showAvatarSelector();
                }
            });

            document.getElementById("btn-avatar-close").addEventListener("click", function () {
                document.getElementById("modal-avatar").classList.add("hidden");
            });

            // ========== MODE TABS (Removed) ==========
            // Tabs replaced by Dashboard Menu Grid

            // ========== READING MODE ==========
            document.getElementById("btn-reading-back").addEventListener("click", function () {
                if (confirm("Á¢∫ÂÆöË¶ÅÈõ¢ÈñãÂóéÔºüÈÄ≤Â∫¶‰∏çÊúÉ‰øùÂ≠ò„ÄÇ")) {
                    switchView("dashboard-view");
                }
            });

            document.getElementById("btn-read-aloud").addEventListener("click", function () {
                if (currentPassage) {
                    var utterance = new SpeechSynthesisUtterance(currentPassage.content);
                    utterance.lang = 'en-US';
                    utterance.rate = 0.85;
                    speechSynthesis.speak(utterance);
                }
            });

            document.getElementById("btn-show-vocab").addEventListener("click", function () {
                var panel = document.getElementById("vocab-panel");
                panel.classList.toggle("hidden");
                this.textContent = panel.classList.contains("hidden") ? "üìù Êü•ÁúãÁîüË©û" : "üìù Èö±ËóèÁîüË©û";
            });

            document.getElementById("btn-start-questions").addEventListener("click", startReadingQuestions);
            document.getElementById("btn-prev-q").addEventListener("click", prevReadingQuestion);
            document.getElementById("btn-next-q").addEventListener("click", nextReadingQuestion);
            document.getElementById("btn-review-answers").addEventListener("click", showAnswerReview);
            document.getElementById("btn-reading-done").addEventListener("click", finishReading);

            // Init
            fetchPlayers();
        });
    </script>
</body>

</html>